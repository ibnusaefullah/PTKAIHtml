<!DOCTYPE html>
<html lang="id" class="">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7 KAIH - UPTD SD Negeri 3 Pekandangan</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Inter (for Splash) & Poppins (for App) -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700;900&family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf-autotable.min.js"></script>

    <script>
        // --- Konfigurasi Tailwind untuk Mode Gelap ---
        tailwind.config = {
          darkMode: 'class',
        }
    </script>

    <style>
        /* [GLOBAL STYLES] */
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f0f2f5;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
        }

        .dark {
            --bg-primary: #121212;
            --bg-secondary: #000000;
            --text-primary: #e5e7eb;
            --text-secondary: #9ca3af;
            --border-color: #374151;
        }
        
        body {  
            font-family: 'Poppins', sans-serif;  
            background-color: var(--bg-secondary);  
            color: var(--text-primary);
            transition: background-color 0.3s, color 0.3s;
        }

        /* [SPLASH SCREEN STYLES] */
        #splash-screen {
            font-family: 'Inter', sans-serif;
        }
        
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        
        .fade-in-up { animation: fadeInUp 0.8s ease-out forwards; }
        .fade-out { animation: fadeOut 0.5s ease-in forwards; }

        .text-gradient {
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
        }

        /* [MAIN APP STYLES] */
        #app-shell, .modal-content, #notification-page-container, #book-details-modal-content {
            background-color: var(--bg-primary);
            color: var(--text-primary);
        }
        main:not(#splash-screen) { background-color: var(--bg-secondary); }
        #app-container { display: none; }
        .page { display: none; animation: fadeIn 0.3s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bottom-nav {
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            background-color: var(--bg-primary);
            border-top-color: var(--border-color);
        }
        .nav-item.active .nav-text { color: #3B82F6; } /* blue-500 */
        .nav-item.active svg { transform: scale(1.1); color: #3B82F6; }
        .nav-item svg { transition: all 0.2s ease-in-out; }
        .input-field { background-color: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 6px; padding: 10px; width: 100%; color: var(--text-primary); }
        .toggle-checkbox:checked { right: 0; border-color: #3897f0; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3897f0; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        .dark .loader { border-color: #4b5563; border-top-color: #3B82F6; }
        .loader-small { border: 2px solid #f3f3f3; border-radius: 50%; border-top: 2px solid #3498db; width: 16px; height: 16px; animation: spin 1s linear infinite; display: inline-block; margin-right: 8px; vertical-align: middle; }
        .dark .loader-small { border-color: #4b5563; border-top-color: #3B82F6; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .follow-btn { padding: 4px 12px; border-radius: 8px; font-weight: 600; font-size: 12px; transition: all 0.2s ease-in-out; }
        .follow-btn.following { background-color: var(--bg-secondary); color: var(--text-secondary); border: 1px solid var(--border-color); }
        .follow-btn.not-following { background-color: #3B82F6; color: white; }
        .badge { transition: transform 0.2s ease-in-out; }
        .badge:hover { transform: scale(1.1); }
        #notification-page-container { transition: transform 0.3s ease-in-out; }
        .activity-card { background-color: var(--bg-primary); border-bottom: 1px solid var(--border-color); }
        .category-btn { scroll-snap-align: start; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* [GLASSMORPHISM LOGIN STYLES] */
        .glass-modal-content {
            background: rgba(31, 41, 55, 0.25); /* Darker translucent background for better contrast on light/dark backgrounds */
            -webkit-backdrop-filter: blur(12px);
            backdrop-filter: blur(12px);
            border-radius: 1.5rem; /* 24px */
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
            color: white; /* Text color needs to be light for contrast */
        }

        .dark .glass-modal-content {
            background: rgba(17, 24, 39, 0.4); /* Slightly different dark mode glass */
            border: 1px solid rgba(255, 255, 255, 0.15);
        }

        .glass-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 0.75rem; /* 12px */
            transition: background 0.2s, border 0.2s;
        }

        .glass-input:focus {
             background: rgba(255, 255, 255, 0.2);
             border-color: rgba(255, 255, 255, 0.5);
        }

        .glass-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }
        
        /* [PULL TO REFRESH STYLES] */
        #app-header {
            position: relative;
            z-index: 10; /* Ensure header is above the refresh indicator */
        }
        #pull-to-refresh-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            padding-top: 10px; /* Add padding to position icon correctly */
            height: 70px; /* Adjust height to account for padding */
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 5; /* Lower z-index than header */
            pointer-events: none;
        }
        #pull-to-refresh-indicator.visible {
            opacity: 1;
        }
        #refresh-icon {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background-color: var(--bg-primary);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            display: flex;
            justify-content: center;
            align-items: center;
            transition: transform 0.2s;
        }
        #refresh-icon svg {
            transition: transform 0.3s;
        }
        #refresh-icon.ready-to-refresh svg {
            transform: rotate(180deg);
        }
        #refresh-icon.refreshing svg {
            animation: spin 1s linear infinite;
        }


    </style>
</head>
<body class="dark:bg-black overflow-hidden">

    <!-- Splash Screen Container -->
    <main id="splash-screen" class="fixed inset-0 z-[100] h-screen w-screen flex flex-col items-center justify-center transition-opacity duration-500 p-6 bg-gray-50 dark:bg-black">
        
        <div class="flex flex-col items-center text-center gap-6">
            <!-- Logo Sekolah -->
            <img id="logo" 
                 src="https://sdn3pekandangan.my.canva.site/ukuran-asli-tanpa-judul/images/d3591436db7dc9fd68140219717adb8a.png" 
                 alt="Logo UPTD SD Negeri 3 Pekandangan" 
                 class="h-28 w-28 object-contain opacity-0"
                 onerror="this.onerror=null;this.src='https://placehold.co/112x112/e2e8f0/334155?text=Logo';">
            
            <!-- Judul Aplikasi (Gaya Gradien) -->
            <h1 id="app-title" class="text-5xl font-black text-gradient bg-gradient-to-r from-blue-500 to-teal-400 dark:from-blue-400 dark:to-teal-300 opacity-0">
                7 KAIH
            </h1>

            <!-- Sub-judul / Nama Lengkap Aplikasi -->
            <p id="app-subtitle" class="text-base text-gray-500 dark:text-gray-400 tracking-wide opacity-0">
                Pemantauan Tujuh Kebiasaan Anak Indonesia Hebat
            </p>
        </div>
        
        <!-- Loading status text on splash screen -->
        <p id="loading-status-splash" class="absolute bottom-24 text-sm text-gray-400 dark:text-gray-500 mt-8 opacity-0">
            <!-- Text will be set by JS -->
        </p>

        <!-- Nama Sekolah di Bagian Bawah -->
        <div id="school-name" class="absolute bottom-10 text-center px-4 opacity-0">
            <p class="text-sm text-gray-400 dark:text-gray-500">
                Dipersembahkan oleh
            </p>
            <p class="font-medium text-gray-600 dark:text-gray-300 mt-1">
                UPTD SD Negeri 3 Pekandangan
            </p>
        </div>
    </main>


    <!-- ### MAIN APPLICATION ### -->
    <!-- Container for the entire application -->
    <div id="app-shell" class="max-w-md mx-auto h-screen shadow-lg relative flex flex-col">

        <!-- Pull to Refresh Indicator -->
        <div id="pull-to-refresh-indicator">
            <div id="refresh-icon">
                <!-- Icon will be dynamically set by JS, starting with home -->
                <svg aria-label="Beranda" class="h-6 w-6 text-gray-500 dark:text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" />
                </svg>
            </div>
        </div>

        <!-- Initial Loading View -->
        <div id="loading-view" class="flex flex-col items-center justify-center h-full" style="background-color: var(--bg-primary);">
            <div class="loader"></div>
            <p id="loading-text" class="mt-4 text-gray-600 dark:text-gray-400 text-center px-4">Menyiapkan aplikasi...</p>
        </div>
        
        <!-- App Container (Main structure) -->
        <div id="app-container" class="h-full flex flex-col">
            <header id="app-header" class="p-4 flex justify-between items-center border-b" style="background-color: var(--bg-primary); border-color: var(--border-color);">
                <h1 id="header-title" class="text-xl font-bold">Beranda</h1>
                <div class="flex items-center gap-4">
                    <button id="notification-btn" class="relative text-gray-600 dark:text-gray-300 hover:text-red-500 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" />
                        </svg>
                        <span id="notification-dot" class="hidden absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2" style="ring-color: var(--bg-primary)"></span>
                    </button>
                    <button id="header-settings-btn" class="text-gray-600 dark:text-gray-300">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" /></svg>
                    </button>
                </div>
            </header>
            <main class="flex-grow overflow-y-auto">
                <div id="page-home" class="page"></div>
                <div id="page-video" class="page p-4"></div>
                <div id="page-book" class="page h-full"></div>
                <div id="page-report" class="page p-4"></div>
                <div id="page-konten" class="page p-4"></div>
                <div id="page-profile" class="page"></div>
            </main>
            <nav class="bottom-nav w-full p-2 border-t">
                <div class="flex justify-around items-center">
                    <button class="nav-item flex-1 flex flex-col items-center p-2 text-gray-500 dark:text-gray-400 hover:text-blue-500 transition-colors active" data-page="home"><span class="text-xs nav-text">Beranda</span></button>
                    <button class="nav-item flex-1 flex flex-col items-center p-2 text-gray-500 dark:text-gray-400 hover:text-blue-500 transition-colors" data-page="video"><span class="text-xs nav-text">Video</span></button>
                    <button class="nav-item flex-1 flex flex-col items-center p-2 text-gray-500 dark:text-gray-400 hover:text-blue-500 transition-colors" data-page="book"><span class="text-xs nav-text">Buku</span></button>
                    <button id="nav-item-report" class="nav-item flex-1 flex flex-col items-center p-2 text-gray-500 dark:text-gray-400 hover:text-blue-500 transition-colors" data-page="report"><span class="text-xs nav-text">Laporan</span></button>
                    <button id="nav-item-konten" class="nav-item flex-1 flex flex-col items-center p-2 text-gray-500 dark:text-gray-400 hover:text-blue-500 transition-colors" data-page="konten" style="display: none;"><span class="text-xs nav-text">Konten</span></button>
                    <button class="nav-item flex-1 flex flex-col items-center p-2 text-gray-500 dark:text-gray-400 hover:text-blue-500 transition-colors" data-page="profile"><span class="text-xs nav-text">Profil</span></button>
                </div>
            </nav>
        </div>
    </div>

    <!-- Modals -->
    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4"></div>
    <div id="content-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4"></div>
    <div id="badge-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4"></div>
    <div id="book-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-end"></div>
    <div id="notification-page-container" class="hidden fixed inset-0 z-50 transform translate-x-full"></div>

    <script>
    // ### COMBINED SCRIPT ###

    // --- SPLASH SCREEN LOGIC ---
    window.onload = () => {
        const splashScreen = document.getElementById('splash-screen');
        const logo = document.getElementById('logo');
        const appTitle = document.getElementById('app-title');
        const appSubtitle = document.getElementById('app-subtitle');
        const schoolName = document.getElementById('school-name');
        const loadingStatusSplash = document.getElementById('loading-status-splash');

        // Initial theme application for splash screen
        applyInitialTheme();

        // Animation sequence
        setTimeout(() => { logo.classList.add('fade-in-up'); }, 300);
        setTimeout(() => { appTitle.classList.add('fade-in-up'); }, 800);
        setTimeout(() => { appSubtitle.classList.add('fade-in-up'); }, 1000);
        setTimeout(() => { schoolName.classList.add('fade-in-up'); }, 1300);
        
        // Animate the loading status text
        setTimeout(() => {
            loadingStatusSplash.textContent = "Menghubungkan ke Data Server...";
            loadingStatusSplash.classList.add('fade-in-up');
        }, 1600);


        // Fade out and transition to main app
        setTimeout(() => { splashScreen.classList.add('fade-out'); }, 3500); 

        setTimeout(() => {
            splashScreen.style.display = 'none';
            document.body.classList.remove('overflow-hidden');
            // Start loading the main application's data
            loadDataFromGoogleSheet();
        }, 4000); 
    };


    // --- MAIN APP LOGIC ---

    // --- ICON DEFINITIONS (Modern Instagram Style) ---
    const icons = {
        home: {
            outline: `<svg aria-label="Beranda" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>`,
            filled: `<svg aria-label="Beranda" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>`
        },
        video: {
            outline: `<svg aria-label="Video" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
            filled: `<svg aria-label="Video" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.134v3.732a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664l-3.197-2.132z" clip-rule="evenodd" /></svg>`
        },
        book: {
            outline: `<svg aria-label="Buku" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>`,
            filled: `<svg aria-label="Buku" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M9 4.804A7.968 7.968 0 005.5 4c-1.255 0-2.443.29-3.5.804v10.392C3.057 14.71 4.245 14 5.5 14c1.255 0 2.443.29 3.5.804V4.804zM14.5 4c-1.255 0-2.443.29-3.5.804v10.392c1.057.514 2.245.804 3.5.804c1.255 0 2.443-.29 3.5-.804V4.804C16.943 4.29 15.755 4 14.5 4z" /></svg>`
        },
        report: {
            outline: `<svg aria-label="Laporan" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
            filled: `<svg aria-label="Laporan" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm1-12a1 1 0 10-2 0v4a1 1 0 00.293.707l2.828 2.829a1 1 0 101.414-1.414L11 10.586V6z" clip-rule="evenodd" /></svg>`
        },
        konten: {
            outline: `<svg aria-label="Konten" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>`,
            filled: `<svg aria-label="Konten" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM3 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H5a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" clip-rule="evenodd" /></svg>`
        },
        profile: {
            outline: `<svg aria-label="Profil" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`,
            filled: `<svg aria-label="Profil" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0012 11z" clip-rule="evenodd" /></svg>`
        }
    };

    // --- KONFIGURASI ---
    let schoolData = {
        name: "SDN Contoh 1",
        npsn: "12345678",
        province: "Jawa Barat",
        city: "Indramayu",
        headmaster: "Dr. H. Sutrisno, M.Pd.",
        headmasterNip: "196504051988031011",
        teacher: "Asep Surasep, S.Pd.",
    };
    const localAdmin = { username: 'guru', password: '123' };
    
    const habits = [
        { name: "Bangun Pagi", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`, hasTimeInput: true },
        { name: "Taat Beribadah", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-2.829a5 5 0 010-7.07m7.072 0a5 5 0 010 7.07M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>` },
        { name: "Berolahraga", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>` },
        { name: "Makan Sehat dan Bergizi", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>` },
        { name: "Gemar Belajar", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>` },
        { name: "Aktif Bermasyarakat", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>` },
        { name: "Tidur Cepat", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`, hasTimeInput: true }
    ];

    const badges = [
        { name: "Bangun Pagi", description: "Disiplin memulai hari lebih awal!", 
          unlockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><defs><linearGradient id="grad-sun" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FFD147"/><stop offset="100%" stop-color="#FFAB2E"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#grad-sun)"/><g fill="#FFF" opacity="0.9"><path d="M32 20a2 2 0 012 2v2a2 2 0 11-4 0v-2a2 2 0 012-2zM45.6 25.4a2 2 0 012.8 0l1.4 1.4a2 2 0 11-2.8 2.8l-1.4-1.4a2 2 0 010-2.8zM18.4 25.4a2 2 0 010 2.8l-1.4 1.4a2 2 0 11-2.8-2.8l1.4-1.4a2 2 0 012.8 0zM24 46h16a2 2 0 110 4H24a2 2 0 110-4z"/></g><circle cx="32" cy="32" r="8" fill="#FFF"/></svg>`,
          lockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><circle cx="32" cy="32" r="30" fill="#E0E0E0"/><path d="M32 20a2 2 0 012 2v2a2 2 0 11-4 0v-2a2 2 0 012-2zM45.6 25.4a2 2 0 012.8 0l1.4 1.4a2 2 0 11-2.8 2.8l-1.4-1.4a2 2 0 010-2.8zM18.4 25.4a2 2 0 010 2.8l-1.4 1.4a2 2 0 11-2.8-2.8l1.4-1.4a2 2 0 012.8 0zM24 46h16a2 2 0 110 4H24a2 2 0 110-4z" fill="#BDBDBD"/><circle cx="32" cy="32" r="8" fill="#BDBDBD"/></svg>`},
        { name: "Taat Beribadah", description: "Selalu mendekatkan diri pada Tuhan.", 
          unlockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><defs><linearGradient id="grad-pray" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#55C8FF"/><stop offset="100%" stop-color="#3A8DFF"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#grad-pray)"/><path d="M22 36l10-16 10 16H22zm0 4h20v4H22v-4z" fill="#FFF" opacity="0.9"/></svg>`, 
          lockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><circle cx="32" cy="32" r="30" fill="#E0E0E0"/><path d="M22 36l10-16 10 16H22zm0 4h20v4H22v-4z" fill="#BDBDBD"/></svg>`},
        { name: "Berolahraga", description: "Menjaga tubuh kuat dan sehat!", 
          unlockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><defs><linearGradient id="grad-sport" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FF7B7B"/><stop offset="100%" stop-color="#FF5252"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#grad-sport)"/><path d="M21 28l9-9 5 5-9 9-5-5zm13 0l5-5 5 5-5 5-5-5z" fill="#FFF" opacity="0.9"/></svg>`, 
          lockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><circle cx="32" cy="32" r="30" fill="#E0E0E0"/><path d="M21 28l9-9 5 5-9 9-5-5zm13 0l5-5 5 5-5 5-5-5z" fill="#BDBDBD"/></svg>`},
        { name: "Makan Sehat dan Bergizi", description: "Energi hebat dari makanan sehat!", 
          unlockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><defs><linearGradient id="grad-food" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#76E236"/><stop offset="100%" stop-color="#36C23D"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#grad-food)"/><path d="M20 28c0-4.4 3.6-8 8-8h8c4.4 0 8 3.6 8 8v8c0 4.4-3.6 8-8 8h-8c-4.4 0-8-3.6-8-8v-8zm4 0v8c0 2.2 1.8 4 4 4h8c2.2 0 4-1.8 4-4v-8c0-2.2-1.8-4-4-4h-8c-2.2 0-4 1.8-4 4z" fill="#FFF" opacity="0.9"/><circle cx="28" cy="32" r="3" fill="#FFF"/><circle cx="36" cy="32" r="3" fill="#FFF"/></svg>`, 
          lockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><circle cx="32" cy="32" r="30" fill="#E0E0E0"/><path d="M20 28c0-4.4 3.6-8 8-8h8c4.4 0 8 3.6 8 8v8c0 4.4-3.6 8-8 8h-8c-4.4 0-8-3.6-8-8v-8zm4 0v8c0 2.2 1.8 4 4 4h8c2.2 0 4-1.8 4-4v-8c0-2.2-1.8-4-4-4h-8c-2.2 0-4 1.8-4 4z" fill="#BDBDBD"/><circle cx="28" cy="32" r="3" fill="#BDBDBD"/><circle cx="36" cy="32" r="3" fill="#BDBDBD"/></svg>`},
        { name: "Gemar Belajar", description: "Ilmu adalah jendela dunia.", 
          unlockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><defs><linearGradient id="grad-learn" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#8E54E9"/><stop offset="100%" stop-color="#4776E6"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#grad-learn)"/><path d="M20 22h24v4H20v-4zm0 8h24v4H20v-4zm0 8h16v4H20v-4z" fill="#FFF" opacity="0.9"/></svg>`, 
          lockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><circle cx="32" cy="32" r="30" fill="#E0E0E0"/><path d="M20 22h24v4H20v-4zm0 8h24v4H20v-4zm0 8h16v4H20v-4z" fill="#BDBDBD"/></svg>`},
        { name: "Aktif Bermasyarakat", description: "Peduli dan bermanfaat bagi sesama.", 
          unlockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><defs><linearGradient id="grad-social" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FF63A6"/><stop offset="100%" stop-color="#E14698"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#grad-social)"/><circle cx="24" cy="26" r="6" fill="#FFF" opacity="0.9"/><path d="M18 42c0-3.3 2.7-6 6-6s6 2.7 6 6v2H18v-2z" fill="#FFF" opacity="0.9"/><circle cx="40" cy="26" r="6" fill="#FFF" opacity="0.9"/><path d="M34 42c0-3.3 2.7-6 6-6s6 2.7 6 6v2H34v-2z" fill="#FFF" opacity="0.9"/></svg>`, 
          lockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><circle cx="32" cy="32" r="30" fill="#E0E0E0"/><circle cx="24" cy="26" r="6" fill="#BDBDBD"/><path d="M18 42c0-3.3 2.7-6 6-6s6 2.7 6 6v2H18v-2z" fill="#BDBDBD"/><circle cx="40" cy="26" r="6" fill="#BDBDBD"/><path d="M34 42c0-3.3 2.7-6 6-6s6 2.7 6 6v2H34v-2z" fill="#BDBDBD"/></svg>`},
        { name: "Tidur Cepat", description: "Istirahat cukup untuk hari yang produktif.", 
          unlockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><defs><linearGradient id="grad-sleep" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#4C5C96"/><stop offset="100%" stop-color="#2C3A70"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#grad-sleep)"/><path d="M44 24c0 6.6-5.4 12-12 12S20 30.6 20 24c0-5.5 3.7-10.1 8.5-11.5.8-.2 1.5.4 1.5 1.2v20.6c0 .8.9 1.3 1.6.8 4.4-3.1 7.4-8 7.4-13.1z" fill="#FFF" opacity="0.9"/><g fill="#FFF" opacity="0.7"><circle cx="22" cy="20" r="2"/><circle cx="20" cy="28" r="1.5"/><circle cx="24" cy="36" r="2"/></g></svg>`, 
          lockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><circle cx="32" cy="32" r="30" fill="#E0E0E0"/><path d="M44 24c0 6.6-5.4 12-12 12S20 30.6 20 24c0-5.5 3.7-10.1 8.5-11.5.8-.2 1.5.4 1.5 1.2v20.6c0 .8.9 1.3 1.6.8 4.4-3.1 7.4-8 7.4-13.1z" fill="#BDBDBD"/><g fill="#BDBDBD" opacity="0.7"><circle cx="22" cy="20" r="2"/><circle cx="20" cy="28" r="1.5"/><circle cx="24" cy="36" r="2"/></g></svg>`},
    ];

    // --- GLOBAL STATE ---
    let GOOGLE_SHEET_URL = 'https://script.google.com/macros/s/AKfycbzc84ll2Ak-YsphKlWdHkRW_PERfkPn2D84zJ7KITQ-L5YE0I717da17KjqteTQ1cTQIA/exec'; 
    let videoCollection = {};
    let bookCollection = {};
    let studentDatabase = {};
    let activityFeed = {};
    let currentStudent = null;
    let currentAdmin = null;
    let notifications = []; 
    let hasUnreadNotifications = false;
    let currentPageId = 'home';

    // --- MAIN ELEMENTS ---
    const el = id => document.getElementById(id);
    const loadingView = el('loading-view');
    const appContainer = el('app-container');
    const loadingText = el('loading-text');

    // --- THEME LOGIC ---
    function applyInitialTheme() {
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'dark') {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }
    }

    function toggleTheme() {
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
    }
    
    // --- DATE PARSING & FORMATTING ---
    function formatDateForSheet(date) {
        const d = new Date(date);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0'); // Month is 0-indexed
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
    }
    
    function formatDateForDisplay(timestamp) {
        return new Date(timestamp).toLocaleDateString('id-ID', {
            weekday: 'long', day: 'numeric', month: 'long', year: 'numeric', hour: '2-digit', minute: '2-digit'
        }).replace(/\./g, ':');
    }

    // --- PULL TO REFRESH ICON UPDATE ---
    function updateRefreshIcon() {
        const refreshIconContainer = el('refresh-icon');
        const iconSet = icons[currentPageId];
        if (refreshIconContainer && iconSet && iconSet.outline) {
            // Use the outline icon for the refresh indicator
            refreshIconContainer.innerHTML = iconSet.outline;
            
            // The SVGs in the `icons` object might have their own classes (e.g., h-7, w-7).
            // We need to ensure the refresh icon has a consistent size.
            const svg = refreshIconContainer.querySelector('svg');
            if (svg) {
                // Remove existing size classes and add the correct ones for the refresh icon
                svg.classList.remove('h-7', 'w-7');
                svg.classList.add('h-6', 'w-6', 'text-gray-500', 'dark:text-gray-400');
                svg.style.transition = 'transform 0.3s'; // Ensure transition is applied for rotation
            }
        }
    }

    // --- INITIALIZATION ---
    async function loadDataFromGoogleSheet(isRefresh = false) {
        if (!GOOGLE_SHEET_URL) {
            loadingText.innerHTML = 'URL Google Sheet belum diatur. Silakan edit variabel `GOOGLE_SHEET_URL` di dalam kode HTML ini.';
            el('loading-view').querySelector('.loader').style.display = 'none';
            return;
        }
        
        if (!isRefresh) {
            loadingView.style.display = 'flex';
        }
        
        try {
            const res = await fetch(GOOGLE_SHEET_URL + "?action=getAllData", { redirect: 'follow' });
            if (!res.ok) {
                throw new Error(`Network response was not ok: ${res.statusText}`);
            }
            const data = await res.json();
            
            studentDatabase = data.students || {};
            videoCollection = data.videos || {};
            bookCollection = data.books || {};
            // Add category and description to book collection for new UI
            Object.keys(bookCollection).forEach((key, index) => {
                const book = bookCollection[key];
                book.category = book.category || ['Fiksi', 'Non-Fiksi', 'Pelajaran', 'Anak'][index % 4];
                book.description = book.description || `Ini adalah deskripsi untuk buku "${book.title}". Baca selengkapnya untuk mengetahui isinya.`;
            });

            activityFeed = data.activityFeed || {};
            
            if (!isRefresh) {
                loadingView.style.display = 'none';
                appContainer.style.display = 'flex';
                initializeNotifications();
                setupEventListeners();
                setupTouchGestures(); // Setup unified touch gestures
            }
            updateNavVisibility();
            const activePageId = document.querySelector('.page.active')?.id.replace('page-', '') || 'home';
            switchPage(activePageId, true); // Force rerender of current page
            
        } catch(e) {
            loadingView.style.display = 'flex';
            loadingText.innerHTML = `Gagal memuat data. Periksa URL Anda dan pastikan skrip telah di-deploy.<br><small>Error: ${e.message}</small>`;
            el('loading-view').querySelector('.loader').style.display = 'none';
            console.error("Error fetching from sheet:", e);
        }
    }
    
    function insertIcons() {
        document.querySelectorAll('.nav-item').forEach(item => {
            const pageId = item.dataset.page;
            const iconSet = icons[pageId];
            if (iconSet && !item.querySelector('svg')) { 
                item.insertAdjacentHTML('afterbegin', iconSet.outline); 
            }
        });
    }

    function setupEventListeners() {
        document.querySelectorAll('.nav-item').forEach(item => { item.addEventListener('click', () => switchPage(item.dataset.page)); });
        el('notification-btn').addEventListener('click', showNotificationPage);
        el('header-settings-btn').addEventListener('click', () => switchPage('profile'));
    }
    
    function switchPage(pageId, forceRerender = false) {
        const currentPage = document.querySelector('.page.active');
        if (!forceRerender && currentPage && currentPage.id === `page-${pageId}`) {
            return; // Don't re-render if it's the same page, unless forced
        }
        
        currentPageId = pageId;
        updateRefreshIcon();

        insertIcons(); 
        document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
        document.querySelectorAll('.nav-item').forEach(item => {
            item.classList.remove('active');
            const iconId = item.dataset.page;
            const iconSet = icons[iconId];
            const existingIcon = item.querySelector('svg');
            if (existingIcon) existingIcon.remove();
            if(iconSet) item.insertAdjacentHTML('afterbegin', iconSet.outline);
             if (item.dataset && item.dataset.page === pageId) {
                 item.classList.add('active');
                 el('header-title').textContent = item.querySelector('.nav-text').textContent;
                 const activeIcon = item.querySelector('svg');
                 if (activeIcon) activeIcon.remove();
                 if(iconSet) item.insertAdjacentHTML('afterbegin', iconSet.filled);
             }
        });
        const newPage = el(`page-${pageId}`);
        if (newPage) newPage.classList.add('active');
        
        if (pageId === 'home') renderHomePage();
        if (pageId === 'video') renderVideoPage();
        if (pageId === 'book') renderBookPage();
        if (pageId === 'report') renderReportPage();
        if (pageId === 'konten') renderKontenPage();
        if (pageId === 'profile') renderProfilePage();
    }

    function updateNavVisibility() {
        const reportButton = el('nav-item-report');
        const kontenButton = el('nav-item-konten');
        
        if (currentStudent) {
            reportButton.style.display = 'flex';
            kontenButton.style.display = 'none';
        } else if (currentAdmin) {
            reportButton.style.display = 'none';
            kontenButton.style.display = 'flex';
        } else { 
            reportButton.style.display = 'none';
            kontenButton.style.display = 'none';
        }
    }
    
    function renderHomePage() {
        const homePage = el('page-home');
        homePage.innerHTML = ''; 
        let contentHTML = '';

        // Allow both students and admins to see the feed
        if (!currentStudent && !currentAdmin) {
            homePage.innerHTML = `<div class="text-center mt-8 p-4"><p>Silakan login untuk melihat feed aktivitas.</p><button onclick="switchPage('profile')" class="mt-4 bg-blue-500 text-white py-2 px-4 rounded-lg">Ke Halaman Profil</button></div>`;
            return;
        }

        // Get all activities without filtering by 'following' list
        const feedArray = Object.values(activityFeed);
        
        // Sort activities by timestamp, newest first
        feedArray.sort((a, b) => parseInt(b.id.split('_')[1]) - parseInt(a.id.split('_')[1]));

        if (feedArray.length === 0) {
            // Updated message for when there's no activity yet
            contentHTML += `<div class="text-center mt-8 p-4"><p>Belum ada aktivitas yang diposting.</p></div>`;
        } else {
            contentHTML += feedArray.map(activity => renderActivityCard(activity)).join('');
        }
        
        // The "Suggestions for you" section is removed as all activities are now shown.
        homePage.innerHTML = contentHTML;
    }
    
    function renderActivityCard(activity) {
        const timestamp = parseInt(activity.id.split('_')[1]);
        const displayDate = formatDateForDisplay(timestamp);
        const likedByArray = Array.isArray(activity.likedBy) ? activity.likedBy : [];
        const isLiked = currentStudent && likedByArray.includes(currentStudent.nisn);
        const habitsToShow = typeof activity.completedHabits === 'string' 
            ? activity.completedHabits.split(',') 
            : (activity.completedHabits || []);

        return `
            <div class="activity-card py-3">
                <div class="flex items-center justify-between px-4 pb-3">
                    <div class="flex items-center gap-3">
                       <img src="${activity.avatar}" onerror="this.src='https://placehold.co/100x100/CCCCCC/FFFFFF?text=Err'" class="w-10 h-10 rounded-full">
                       <div>
                            <p class="font-bold text-sm">${activity.name}</p>
                            <p class="text-xs" style="color: var(--text-secondary)">Kelas ${activity.class}</p>
                       </div>
                    </div>
                </div>
                
                <div class="px-4">
                    <p class="font-semibold text-sm mb-2">Telah menyelesaikan:</p>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                          ${habitsToShow.map(habit => {
                              const habitInfo = habits.find(h => h.name === habit);
                              return `<div class="flex items-center gap-2 p-2 rounded-lg" style="background-color: var(--bg-secondary);"><span style="color: var(--text-secondary)">${habitInfo ? habitInfo.icon : ''}</span><span>${habit}</span></div>`
                          }).join('')}
                    </div>
                </div>

                <div class="px-4 pt-4 flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <button onclick="handleLikePost('${activity.id}')" class="flex items-center gap-2">
                            ${isLiked
                                ? `<svg aria-label="Batal Suka" class="h-7 w-7 text-red-500" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd"></path></svg>`
                                : `<svg aria-label="Suka" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z"></path></svg>`
                            }
                        </button>
                    </div>
                </div>
                <div class="px-4 pt-2">
                    <p class="font-semibold text-sm">${activity.likes || 0} suka</p>
                    <p class="text-xs pt-1" style="color: var(--text-secondary);">${displayDate}</p>
                </div>
            </div>`;
    }


    function renderVideoPage() {
        const videoPage = el('page-video');
        const videos = Object.values(videoCollection);
        if (videos.length === 0) {
            videoPage.innerHTML = `<p class="text-center mt-8">Belum ada video yang tersedia.</p>`; return;
        }
        videoPage.innerHTML = `<div class="grid grid-cols-1 gap-4">${videos.map(video => `<div class="rounded-lg shadow-sm overflow-hidden" style="background-color: var(--bg-primary);"><div class="relative w-full aspect-video bg-gray-300 dark:bg-gray-700 flex items-center justify-center"><iframe class="w-full h-full" src="https://www.youtube.com/embed/${video.youtubeId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div><div class="p-4"><h3 class="font-semibold">${video.title}</h3><p class="text-sm" style="color: var(--text-secondary)">Video pembelajaran</p></div></div>`).join('')}</div>`;
    }

    function renderBookPage() {
        const bookPage = el('page-book');
        const books = Object.values(bookCollection);
        const categories = ["Semua", ...new Set(books.map(book => book.category || "Lainnya"))];

        bookPage.innerHTML = `
            <div class="flex flex-col h-full">
                <div class="p-3 sticky top-0" style="background-color: var(--bg-primary);">
                    <div class="relative mb-3">
                        <input type="search" id="book-search-input" class="input-field !rounded-full pl-10" placeholder="Cari di perpustakaan...">
                        <div class="absolute inset-y-0 left-0 flex items-center pl-4 pointer-events-none">
                            <svg class="w-5 h-5" style="color: var(--text-secondary);" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                        </div>
                    </div>
                    <div id="book-categories" class="flex space-x-2 overflow-x-auto pb-1 no-scrollbar" style="scroll-snap-type: x mandatory;">
                        ${categories.map((cat, index) => `
                            <button class="category-btn flex-shrink-0 text-sm font-semibold py-2 px-4 rounded-full transition-colors ${index === 0 ? 'bg-blue-500 text-white shadow' : 'bg-gray-200 text-gray-700 dark:bg-gray-700 dark:text-gray-200'}" data-category="${cat}">
                                ${cat}
                            </button>
                        `).join('')}
                    </div>
                </div>
                <div id="book-grid-container" class="flex-grow overflow-y-auto px-3 pb-3">
                    <div id="book-grid" class="grid grid-cols-3 gap-2">
                    </div>
                    <div id="no-books-found" class="hidden text-center py-16" style="color: var(--text-secondary);">
                        <svg xmlns="http://www.w3.org/2000/svg" class="mx-auto h-16 w-16" style="color: var(--border-color);" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                        <p class="font-semibold mt-4">Buku tidak ditemukan</p>
                        <p class="text-sm">Coba gunakan kata kunci atau kategori yang lain.</p>
                    </div>
                </div>
            </div>
        `;
        
        displayBooks();

        el('book-search-input').addEventListener('input', displayBooks);
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                document.querySelectorAll('.category-btn').forEach(b => {
                    b.classList.remove('bg-blue-500', 'text-white', 'shadow');
                    b.classList.add('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
                });
                e.currentTarget.classList.add('bg-blue-500', 'text-white', 'shadow');
                e.currentTarget.classList.remove('bg-gray-200', 'text-gray-700', 'dark:bg-gray-700', 'dark:text-gray-200');
                displayBooks();
            });
        });
    }

    function displayBooks() {
        const grid = el('book-grid');
        const noResults = el('no-books-found');
        const searchQuery = el('book-search-input').value.toLowerCase();
        const activeCategoryBtn = document.querySelector('.category-btn.bg-blue-500');
        const selectedCategory = activeCategoryBtn ? activeCategoryBtn.dataset.category : 'Semua';

        let filteredBooks = Object.values(bookCollection);

        if (selectedCategory !== 'Semua') {
            filteredBooks = filteredBooks.filter(book => (book.category || "Lainnya") === selectedCategory);
        }

        if (searchQuery) {
            filteredBooks = filteredBooks.filter(book => book.title.toLowerCase().includes(searchQuery));
        }
        
        if (filteredBooks.length > 0) {
            grid.innerHTML = '';
            noResults.classList.add('hidden');
            grid.classList.remove('hidden');
            filteredBooks.forEach(book => {
                const bookEl = document.createElement('div');
                bookEl.className = 'w-full aspect-[2/3] bg-cover bg-center cursor-pointer rounded-lg shadow-md transition-transform duration-200 hover:scale-105';
                bookEl.style.backgroundImage = `url('${book.cover}')`;
                bookEl.style.backgroundColor = 'var(--bg-secondary)';
                bookEl.addEventListener('click', () => showBookDetailModal(book.id));
                grid.appendChild(bookEl);
            });
        } else {
            grid.innerHTML = '';
            grid.classList.add('hidden');
            noResults.classList.remove('hidden');
        }
    }
    
    function showBookDetailModal(bookId) {
        const book = bookCollection[bookId];
        if (!book) return;

        const modal = el('book-details-modal');
        modal.innerHTML = `
            <div id="book-details-modal-content" class="w-full rounded-t-2xl p-4 transition-transform transform translate-y-full">
                 <div class="w-12 h-1.5 bg-gray-300 dark:bg-gray-600 rounded-full mx-auto mb-4"></div>
                 <div class="flex gap-4 items-start">
                    <img src="${book.cover}" onerror="this.src='https://placehold.co/100x140/CCCCCC/FFFFFF?text=Err'" class="w-24 h-36 object-cover rounded-lg shadow-lg flex-shrink-0">
                    <div class="flex-grow">
                        <h3 class="font-bold text-lg">${book.title}</h3>
                        <p class="text-sm font-medium text-blue-500 mb-2">${book.category}</p>
                        <p class="text-sm" style="color: var(--text-secondary);">${book.description}</p>
                    </div>
                 </div>
                 <a href="${book.url}" target="_blank" class="block w-full text-center bg-blue-500 text-white font-bold py-3 px-4 rounded-lg mt-6 hover:bg-blue-600 transition">
                    Baca Sekarang
                 </a>
            </div>
        `;
        modal.classList.remove('hidden');
        
        const modalContent = el('book-details-modal-content');
        setTimeout(() => {
            modalContent.classList.remove('translate-y-full');
        }, 10);

        modal.addEventListener('click', (e) => {
             if (e.target.id === 'book-details-modal') {
                 modalContent.classList.add('translate-y-full');
                 setTimeout(() => modal.classList.add('hidden'), 300);
             }
        });
    }
    
    function renderProfilePage() {
        const profilePage = el('page-profile');
        
        if(currentStudent) {
            const studentData = studentDatabase[currentStudent.nisn];
            const achievements = studentData.achievements || {};

            profilePage.innerHTML = `
            <div class="space-y-4 p-4">
                <div class="p-4 rounded-xl" style="background-color: var(--bg-primary);">
                    <div class="flex items-center">
                        <img src="${studentData.avatar}" onerror="this.src='https://placehold.co/100x100/CCCCCC/FFFFFF?text=Err'" class="w-20 h-20 rounded-full border-4 shadow-lg" style="border-color: var(--bg-primary)">
                        <div class="flex-grow flex justify-around">
                            <div class="text-center"><p class="font-bold text-lg">${studentData.points || 0}</p><p class="text-sm" style="color: var(--text-secondary)">Poin</p></div>
                            <div class="text-center"><p class="font-bold text-lg">${(studentData.followers || []).length}</p><p class="text-sm" style="color: var(--text-secondary)">Pengikut</p></div>
                            <div class="text-center"><p class="font-bold text-lg">${(studentData.following || []).length}</p><p class="text-sm" style="color: var(--text-secondary)">Mengikuti</p></div>
                        </div>
                    </div>
                    <h3 class="text-lg font-bold mt-3">${currentStudent.name}</h3>
                    <p class="text-sm" style="color: var(--text-secondary)">NISN: ${currentStudent.nisn}</p>
                </div>
                
                <div class="p-4 rounded-xl" style="background-color: var(--bg-primary);">
                    <h3 class="text-sm font-bold mb-2">Lencana Pencapaian</h3>
                    <div class="grid grid-cols-4 gap-4">
                        ${badges.map(badge => {
                            const habitAchievements = achievements[badge.name] || [];
                            const completions = habitAchievements.length;
                            const isUnlocked = completions >= 20;
                            const icon = isUnlocked ? badge.unlockedIcon : badge.lockedIcon;
                            const toastMessage = isUnlocked ? '' : `Selesaikan ${20 - completions} kali lagi untuk membuka lencana ini!`;
                            const clickAction = isUnlocked ? `showBadgeDetailsModal('${badge.name}')` : `alert('${toastMessage}')`;
                            return `<div onclick="${clickAction}" class="badge flex flex-col items-center cursor-pointer"><div class="w-14 h-14">${icon}</div><span class="text-xs text-center mt-1 font-medium ${isUnlocked ? '' : 'opacity-50'}">${badge.name}</span></div>`;
                        }).join('')}
                    </div>
                </div>

                <div class="p-4 rounded-xl" style="background-color: var(--bg-primary);">
                    <h3 class="text-sm font-bold mb-2">Pengaturan & Laporan</h3>
                    <div id="settings-container"></div>
                </div>

                <button onclick="handleLogout()" class="w-full bg-red-500 text-white py-2.5 rounded-lg hover:bg-red-600 transition">Logout</button>
            </div>`;
            renderSettings();
        } else if (currentAdmin) {
             profilePage.innerHTML = `
                <div class="p-4 space-y-4">
                    <div class="p-6 rounded-xl text-center" style="background-color: var(--bg-primary);">
                        <img src="https://placehold.co/100x100/34D399/FFFFFF?text=G" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 shadow-lg" style="border-color: var(--bg-primary)">
                        <h3 class="text-xl font-bold">${currentAdmin.username}</h3>
                        <p style="color: var(--text-secondary)">Guru / Admin</p>
                    </div>
                     <div class="p-4 rounded-xl" style="background-color: var(--bg-primary);">
                         <h3 class="text-sm font-bold mb-2">Pengaturan</h3>
                         <div id="settings-container"></div>
                         <div class="border-t pt-4 mt-4" style="border-color: var(--border-color);">
                            <button onclick="showSchoolDataModal()" class="flex items-center justify-between w-full py-2">
                               <span class="font-medium">Edit Data Sekolah</span>
                               <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                            </button>
                         </div>
                     </div>
                    <button onclick="handleLogout()" class="w-full bg-red-500 text-white py-2.5 rounded-lg hover:bg-red-600 transition">Logout</button>
                </div>
            `;
            renderSettings();
        } else {
            profilePage.innerHTML = `
            <div class="p-4">
                <div class="p-6 rounded-xl text-center" style="background-color: var(--bg-primary);">
                    <img src="https://placehold.co/100x100/CBD5E1/FFFFFF?text=?" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 shadow-lg" style="border-color: var(--bg-primary)">
                    <h3 class="text-lg font-bold">Anda Belum Login</h3>
                    <p class="mb-4" style="color: var(--text-secondary)">Silakan login untuk melanjutkan.</p>
                    <div class="space-y-3">
                        <button id="show-student-login-btn" class="w-full bg-blue-500 text-white py-2 rounded-lg">Login sebagai Siswa</button>
                        <button id="show-admin-login-btn" class="w-full bg-gray-700 text-white py-2 rounded-lg">Login sebagai Guru</button>
                    </div>
                </div>
            </div>`;
            el('show-student-login-btn').addEventListener('click', () => showLoginModal('student'));
            el('show-admin-login-btn').addEventListener('click', () => showLoginModal('admin'));
        }
    }

    function renderSettings() {
        const container = el('settings-container');
        if (!container) return;

        const isDarkMode = document.documentElement.classList.contains('dark');

        let reportButtonsHTML = '';
        if (currentStudent) {
            reportButtonsHTML = `
                <div class="border-t pt-4 mt-4" style="border-color: var(--border-color);">
                    <button onclick="generateParentReflectionPDF(currentStudent)" class="flex items-center justify-between w-full py-2">
                       <span class="font-medium">Unduh Refleksi Orang Tua</span>
                       <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    </button>
                    <button onclick="downloadMonthlyReportPDF()" class="flex items-center justify-between w-full py-2">
                        <span class="font-medium">Unduh Laporan Bulanan</span>
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                    </button>
                </div>
            `;
        }

        container.innerHTML = `
            <div class="flex items-center justify-between py-2">
                <div class="flex items-center gap-3">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                    </svg>
                    <span class="font-medium">Mode Gelap</span>
                </div>
                <label for="dark-mode-toggle" class="relative inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="dark-mode-toggle" class="sr-only peer" ${isDarkMode ? 'checked' : ''}>
                    <div class="w-11 h-6 bg-gray-200 rounded-full peer peer-focus:ring-4 peer-focus:ring-blue-300 dark:peer-focus:ring-blue-800 dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-0.5 after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-blue-600"></div>
                </label>
            </div>
            ${reportButtonsHTML}
        `;
        el('dark-mode-toggle').addEventListener('change', toggleTheme);
    }

    function renderKontenPage() {
        const container = el('page-konten');
        if (!currentAdmin) {
            container.innerHTML = `<div class="text-center mt-8 p-4"><p>Hanya admin yang dapat mengakses halaman ini.</p><button onclick="switchPage('home')" class="mt-4 bg-blue-500 text-white py-2 px-4 rounded-lg">Kembali ke Beranda</button></div>`;
            return;
        }

        const videos = Object.values(videoCollection);
        const books = Object.values(bookCollection);

        container.innerHTML = `
            <div class="space-y-6">
                <section class="p-4 rounded-xl" style="background-color: var(--bg-primary);">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">Kelola Video</h2>
                        <button onclick="showContentModal('video')" class="bg-blue-500 text-white text-sm font-semibold py-1.5 px-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Tambah
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        ${videos.map(video => `
                            <div class="rounded-lg overflow-hidden border" style="border-color: var(--border-color);">
                                <img src="https://img.youtube.com/vi/${video.youtubeId}/0.jpg" alt="${video.title}" class="w-full h-24 object-cover">
                                <div class="p-2">
                                    <h3 class="font-semibold text-sm truncate">${video.title}</h3>
                                    <div class="flex gap-2 mt-2">
                                        <button onclick="showContentModal('video', '${video.id}')" class="flex-1 bg-gray-200 dark:bg-gray-700 text-xs font-semibold py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">Edit</button>
                                        <button onclick="handleDeleteContent('video', '${video.id}')" class="flex-1 bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-400 text-xs font-semibold py-1 rounded-md hover:bg-red-200 dark:hover:bg-red-900/80">Hapus</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </section>

                <section class="p-4 rounded-xl" style="background-color: var(--bg-primary);">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-lg font-bold">Kelola Buku</h2>
                        <button onclick="showContentModal('book')" class="bg-blue-500 text-white text-sm font-semibold py-1.5 px-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-1">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                            Tambah
                        </button>
                    </div>
                    <div class="grid grid-cols-2 gap-4">
                        ${books.map(book => `
                            <div class="rounded-lg overflow-hidden border" style="border-color: var(--border-color);">
                                <img src="${book.cover}" alt="${book.title}" onerror="this.src='https://placehold.co/200x280/CCCCCC/FFFFFF?text=No+Image'" class="w-full h-32 object-cover">
                                <div class="p-2">
                                    <h3 class="font-semibold text-sm truncate">${book.title}</h3>
                                    <div class="flex gap-2 mt-2">
                                        <button onclick="showContentModal('book', '${book.id}')" class="flex-1 bg-gray-200 dark:bg-gray-700 text-xs font-semibold py-1 rounded-md hover:bg-gray-300 dark:hover:bg-gray-600">Edit</button>
                                        <button onclick="handleDeleteContent('book', '${book.id}')" class="flex-1 bg-red-100 text-red-700 dark:bg-red-900/50 dark:text-red-400 text-xs font-semibold py-1 rounded-md hover:bg-red-200 dark:hover:bg-red-900/80">Hapus</button>
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </section>

                <section class="p-4 rounded-xl" style="background-color: var(--bg-primary);">
                     <h3 class="text-lg font-bold">Unduh Laporan Siswa</h3>
                     <div id="admin-report-controls" class="pt-4"></div>
                </section>
            </div>
        `;
        renderAdminReportDownloader();
    }
    
    function renderAdminReportDownloader() {
        const controlsContainer = el('admin-report-controls');
        if (!controlsContainer) return;

        const classes = [...new Set(Object.values(studentDatabase).map(s => s.class))].sort();

        controlsContainer.innerHTML = `
            <div class="space-y-4">
                <div>
                    <label for="class-select" class="block text-sm font-medium mb-1">Pilih Kelas</label>
                    <select id="class-select" class="input-field">
                        <option value="">-- Semua Kelas --</option>
                        ${classes.map(c => `<option value="${c}">Kelas ${c}</option>`).join('')}
                    </select>
                </div>
                <div>
                    <label for="student-select" class="block text-sm font-medium mb-1">Pilih Siswa</label>
                    <select id="student-select" class="input-field" disabled>
                        <option value="">-- Pilih Kelas Dahulu --</option>
                    </select>
                </div>
                <div id="admin-download-buttons" class="hidden pt-4 mt-4 border-t" style="border-color: var(--border-color)"></div>
            </div>
        `;

        const classSelect = el('class-select');
        const studentSelect = el('student-select');

        classSelect.addEventListener('change', () => {
            const selectedClass = classSelect.value;
            studentSelect.innerHTML = '<option value="">-- Pilih Siswa --</option>';
            el('admin-download-buttons').classList.add('hidden');

            if (selectedClass) {
                const studentsInClass = Object.values(studentDatabase).filter(data => data.class === selectedClass);
                studentSelect.innerHTML += studentsInClass.map(data => `<option value="${data.nisn}">${data.name}</option>`).join('');
                studentSelect.disabled = false;
            } else {
                studentSelect.disabled = true;
                studentSelect.innerHTML = '<option value="">-- Pilih Kelas Dahulu --</option>';
            }
        });

        studentSelect.addEventListener('change', () => {
            const selectedNisn = studentSelect.value;
            const downloadButtonsContainer = el('admin-download-buttons');

            if (selectedNisn) {
                const studentData = studentDatabase[selectedNisn];
                downloadButtonsContainer.innerHTML = `
                    <div class="space-y-2">
                       <button onclick='generateParentReflectionPDF(${JSON.stringify(studentData)})' class="flex items-center justify-between w-full py-2 text-left">
                           <span class="font-medium">Unduh Refleksi Orang Tua</span>
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                       </button>
                       <button onclick='downloadMonthlyReportPDF()' class="flex items-center justify-between w-full py-2 text-left">
                           <span class="font-medium">Unduh Laporan Bulanan</span>
                           <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" /></svg>
                       </button>
                    </div>
                `;
                downloadButtonsContainer.classList.remove('hidden');
            } else {
                downloadButtonsContainer.classList.add('hidden');
            }
        });
    }


    function renderReportPage() {
        const container = el('page-report');
        if (!currentStudent) {
            container.innerHTML = `<div class="text-center mt-8 p-4"><p>Silakan login sebagai siswa untuk mengisi laporan.</p><button onclick="switchPage('profile')" class="mt-4 bg-blue-500 text-white py-2 px-4 rounded-lg">Ke Halaman Profil</button></div>`;
            return;
        }
        const habitHTML = habits.map(habit => {
            const habitId = habit.name.toLowerCase().replace(/\s/g, '-').replace(/&/g, 'dan');
            const timeInputHTML = habit.hasTimeInput ? `<input type="time" id="${habitId}-time" class="input-field text-sm w-28 mx-2 p-1.5 hidden">` : '';
            return `<div class="flex items-center justify-between p-3 rounded-lg border" style="background-color: var(--bg-primary); border-color: var(--border-color);"><div class="flex items-center gap-3 flex-grow"><span>${habit.icon}</span><span class="font-medium">${habit.name}</span></div>${timeInputHTML}<div class="relative inline-block w-10 mr-2 align-middle select-none"><input type="checkbox" name="${habitId}" id="${habitId}" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/><label for="${habitId}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div></div>`;
        }).join('');
        container.innerHTML = `<form id="habit-form"><h2 class="font-bold text-lg mb-3 text-center">Isi Laporan Hari Ini</h2><p class="text-center mb-4" style="color: var(--text-secondary);">${new Date().toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'})}</p><div class="space-y-4">${habitHTML}</div><div class="mt-6"><button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2.5 px-6 rounded-lg transition">Posting Aktivitas</button></div></form>`;
        container.querySelector('#habit-form').addEventListener('submit', handleHabitFormSubmit);
        container.querySelectorAll('.toggle-checkbox').forEach(toggle => {
            toggle.addEventListener('change', (event) => {
                const timeInput = container.querySelector(`#${event.target.id}-time`);
                if (timeInput) timeInput.classList.toggle('hidden', !event.target.checked);
            });
        });
    }
    
    // --- LOGIN MODAL (UPDATED WITH GLASSMORPHISM) ---
    function showLoginModal(type) {
        const loginModal = el('login-modal');
        const title = type === 'student' ? 'Login Siswa' : 'Login Guru';
        const formContent = type === 'student'
            ? `<div class="mb-4">
                   <label for="nisn-input" class="block text-sm font-medium text-gray-200 mb-2">NISN</label>
                   <input type="number" id="nisn-input" class="w-full p-3 text-center glass-input focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="Masukkan NISN Anda" required>
               </div>`
            : `<div class="mb-4">
                   <label for="admin-username" class="block text-sm font-medium text-gray-200 mb-2">Nama Pengguna</label>
                   <input type="text" id="admin-username" class="w-full p-3 glass-input focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="guru" required>
               </div>
               <div class="mb-6">
                   <label for="admin-password" class="block text-sm font-medium text-gray-200 mb-2">Kata Sandi</label>
                   <input type="password" id="admin-password" class="w-full p-3 glass-input focus:outline-none focus:ring-2 focus:ring-blue-400" placeholder="" required>
               </div>`;

        loginModal.innerHTML = `
            <div class="glass-modal-content p-8 shadow-xl w-full max-w-sm text-white">
                <h2 class="text-3xl font-bold mb-2 text-center">${title}</h2>
                <p class="text-center text-gray-300 mb-8">Selamat datang kembali!</p>
                <form id="login-form-modal">
                    ${formContent}
                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 rounded-xl transition duration-300">
                        Masuk
                    </button>
                    <button type="button" class="close-modal-btn w-full text-center text-gray-300 mt-4 text-sm hover:text-white">
                        Batal
                    </button>
                </form>
            </div>`;

        loginModal.querySelector('.close-modal-btn').addEventListener('click', () => loginModal.classList.add('hidden'));
        loginModal.querySelector('#login-form-modal').addEventListener('submit', (e) => handleLoginSubmit(e, type));
        loginModal.classList.remove('hidden');
    }

    async function handleLoginSubmit(e, type) {
        e.preventDefault();
        let nisnToLogin;
        if (type === 'student') {
            nisnToLogin = el('nisn-input').value;
            await loginWithNisn(nisnToLogin);
        } else { // admin
            const adminUsernameInput = el('admin-username');
            const passwordInput = el('admin-password');
            if (adminUsernameInput.value === localAdmin.username && passwordInput.value === localAdmin.password) {
                currentAdmin = { username: adminUsernameInput.value };
                currentStudent = null;
                el('login-modal').classList.add('hidden');
                updateNavVisibility();
                switchPage('home');
            } else { 
                alert('Username atau password guru salah!'); 
                return; 
            }
        }
    }

    async function loginWithNisn(nisn) {
        let student = studentDatabase[nisn];
        if (student) {
            const currentMonth = new Date().getMonth() + 1;
            if (student.lastLoginMonth !== currentMonth) {
                student.points = 0;
                student.achievements = {};
                student.lastLoginMonth = currentMonth;
                await postData({ action: 'updateStudentData', payload: student });
            }
            currentStudent = student;
            currentAdmin = null;
            el('login-modal').classList.add('hidden');
            updateNavVisibility();
            switchPage('home');
            alert(`Selamat datang, ${student.name}!`);
        } else { 
            alert('NISN tidak valid atau tidak ditemukan.');
        }
    }

    function handleLogout() {
        currentStudent = null;
        currentAdmin = null;
        updateNavVisibility();
        switchPage('home'); // Redirect to home page after logout for clearer feedback
    }
    
    async function handleHabitFormSubmit(e) {
        e.preventDefault();
        const form = e.target;
        const submitButton = form.querySelector('button[type="submit"]');

        const todayString = formatDateForSheet(new Date()); // e.g., "01/07/2025"
        const todaysPost = Object.values(activityFeed).find(act => 
            act.nisn === currentStudent.nisn && act.date === todayString
        );
        if (todaysPost) {
            alert('Anda sudah memposting aktivitas untuk hari ini.');
            return;
        }

        const completedHabits = habits
            .filter(h => el(h.name.toLowerCase().replace(/\s/g, '-').replace(/&/g, 'dan')).checked)
            .map(h => h.name);

        if (completedHabits.length === 0) {
            alert('Pilih minimal satu aktivitas.');
            return;
        }

        submitButton.disabled = true;
        submitButton.innerHTML = `<span class="loader-small"></span> Mengirim...`;
        
        const newActivityDate = formatDateForSheet(new Date());

        const newActivityId = `act_${Date.now()}`;
        const newActivity = {
            id: newActivityId,
            nisn: currentStudent.nisn,
            name: currentStudent.name,
            class: currentStudent.class,
            date: newActivityDate, 
            completedHabits: completedHabits.join(','), 
            avatar: currentStudent.avatar,
            likes: 0,
            likedBy: []
        };

        const studentDataToUpdate = JSON.parse(JSON.stringify(studentDatabase[currentStudent.nisn]));
        const pointsEarned = completedHabits.length;
        studentDataToUpdate.points = (studentDataToUpdate.points || 0) + pointsEarned;
        
        completedHabits.forEach(habitName => {
            if (!studentDataToUpdate.achievements) studentDataToUpdate.achievements = {};
            if (!studentDataToUpdate.achievements[habitName]) {
                studentDataToUpdate.achievements[habitName] = [];
            }
            const dateForAchievement = new Date().toISOString().slice(0, 10);
            if (!studentDataToUpdate.achievements[habitName].includes(dateForAchievement)) {
                studentDataToUpdate.achievements[habitName].push(dateForAchievement);
            }
        });

        const payload = {
            studentUpdate: studentDataToUpdate,
            activity: newActivity,
            dailyPoints: {
                id: `pts_${currentStudent.nisn}_${todayString.replace(/\//g,'-')}`,
                nisn: currentStudent.nisn,
                date: todayString,
                points: pointsEarned
            }
        };
        
        const result = await postData({ action: 'saveActivityAndStudentData', payload: payload });

        if (result.status === 'success') {
            activityFeed[newActivityId] = newActivity;
            studentDatabase[currentStudent.nisn] = studentDataToUpdate;
            currentStudent = studentDataToUpdate;
            alert('Aktivitas berhasil diposting!');
            switchPage('home');
        } else {
            alert(`Gagal memposting aktivitas: ${result.message || 'Terjadi kesalahan.'}`);
        }
        
        submitButton.disabled = false;
        submitButton.innerHTML = `Posting Aktivitas`;
    }
    
    function showBadgeDetailsModal(habitName) {
        const badge = badges.find(b => b.name === habitName);
        const studentData = studentDatabase[currentStudent.nisn];
        const habitAchievements = studentData.achievements[habitName] || [];
        const totalCompletions = habitAchievements.length;

        const months = [...new Set(habitAchievements.map(dateStr => {
            const date = new Date(dateStr);
            return date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
        }))];

        const modalContent = `
            <div class="p-6 rounded-2xl shadow-xl w-full max-w-xs text-center relative modal-content">
                <button onclick="el('badge-details-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
                <div class="mx-auto w-20 h-20">${badge.unlockedIcon}</div>
                <h3 class="text-lg font-bold mt-4">${badge.name}</h3>
                <p class="text-sm" style="color: var(--text-secondary)">${badge.description}</p>
                <div class="mt-4 bg-blue-50 dark:bg-blue-900/50 p-3 rounded-lg">
                    <p class="text-sm font-medium text-blue-800 dark:text-blue-300">Total diselesaikan</p>
                    <p class="text-2xl font-bold text-blue-600 dark:text-blue-400">${totalCompletions} kali</p>
                </div>
            </div>
        `;
        const modalContainer = el('badge-details-modal');
        modalContainer.innerHTML = modalContent;
        modalContainer.classList.remove('hidden');
    }

    async function handleLikePost(activityId) {
        if (!currentStudent) return;

        const activity = activityFeed[activityId];
        if (!activity) return;
        
        const likerNisn = currentStudent.nisn;
        if (!activity.likedBy) activity.likedBy = [];
        const wasLiked = activity.likedBy.includes(likerNisn);

        activity.likes = (activity.likes || 0) + (wasLiked ? -1 : 1);
        if (wasLiked) {
            activity.likedBy = activity.likedBy.filter(nisn => nisn !== likerNisn);
        } else {
            activity.likedBy.push(likerNisn);
        }
        renderHomePage();

        await postData({ action: 'updateActivity', payload: activity });
    }

    async function handleFollowToggle(targetNisn) {
        if (!currentStudent) return;
        
        const currentUserNisn = currentStudent.nisn;
        const currentUserData = studentDatabase[currentUserNisn];
        const targetUserData = studentDatabase[targetNisn];

        if (!currentUserData || !targetUserData) return;

        if (!currentUserData.following) currentUserData.following = [];
        if (!targetUserData.followers) targetUserData.followers = [];

        const isFollowing = currentUserData.following.includes(targetNisn);

        if (isFollowing) {
            currentUserData.following = currentUserData.following.filter(nisn => nisn !== targetNisn);
            targetUserData.followers = targetUserData.followers.filter(nisn => nisn !== currentUserNisn);
        } else {
            currentUserData.following.push(targetNisn);
            targetUserData.followers.push(currentUserNisn);
        }

        studentDatabase[currentUserNisn] = currentUserData;
        studentDatabase[targetNisn] = targetUserData;
        currentStudent = currentUserData;
        
        renderHomePage();
        
        await postData({ action: 'updateBulkStudents', payload: [currentUserData, targetUserData] });
    }
    
    // --- UNIFIED TOUCH GESTURE LOGIC ---
    function setupTouchGestures() {
        const appShell = el('app-shell');
        const mainContent = appShell.querySelector('main');
        const ptrIndicator = el('pull-to-refresh-indicator');
        const refreshIcon = el('refresh-icon');

        let startX = 0, startY = 0;
        let deltaX = 0, deltaY = 0;
        let gesture = null; // null, 'vertical', or 'horizontal'
        
        const pullThreshold = 80;
        const swipeThreshold = 50;
        const gestureLockThreshold = 10; // Pixels to move before locking gesture direction

        appShell.addEventListener('touchstart', (e) => {
            // Ignore gestures on inputs, buttons, etc.
            if (e.target.closest('input, button, a, select, textarea')) return;
            
            startX = e.touches[0].screenX;
            startY = e.touches[0].screenY;
            gesture = null;
        }, { passive: true });

        appShell.addEventListener('touchmove', (e) => {
            if (gesture === 'horizontal') {
                // Horizontal swipe is in progress, could add visual feedback here if desired
                return;
            }

            deltaX = e.touches[0].screenX - startX;
            deltaY = e.touches[0].screenY - startY;

            if (!gesture) {
                if (Math.abs(deltaX) > gestureLockThreshold || Math.abs(deltaY) > gestureLockThreshold) {
                    gesture = Math.abs(deltaX) > Math.abs(deltaY) ? 'horizontal' : 'vertical';
                }
            }

            if (gesture === 'vertical') {
                // Only handle pull-to-refresh if scrolling up from the top
                if (mainContent.scrollTop === 0 && deltaY > 0) {
                    e.preventDefault(); // Prevent browser's default pull-to-refresh
                    ptrIndicator.classList.add('visible');
                    const pullDistance = deltaY;
                    const rotation = Math.min(pullDistance, pullThreshold) / pullThreshold * 180;
                    refreshIcon.style.transform = `translateY(${pullDistance / 2}px)`;
                    const svg = refreshIcon.querySelector('svg');
                    if (svg) {
                        svg.style.transform = `rotate(${rotation}deg)`;
                    }

                    if (pullDistance >= pullThreshold) {
                        refreshIcon.classList.add('ready-to-refresh');
                    } else {
                        refreshIcon.classList.remove('ready-to-refresh');
                    }
                }
            }
        }, { passive: false });

        appShell.addEventListener('touchend', (e) => {
            if (gesture === 'vertical') {
                if (deltaY > pullThreshold && mainContent.scrollTop === 0) {
                    handleRefresh();
                } else {
                    ptrIndicator.classList.remove('visible');
                    refreshIcon.style.transform = 'translateY(0px)';
                }
            } else if (gesture === 'horizontal') {
                if (Math.abs(deltaX) > swipeThreshold) {
                    handleSwipe(deltaX);
                }
            }
            
            // Reset gesture state
            gesture = null;
            deltaX = 0;
            deltaY = 0;
        });

        function handleSwipe(deltaX) {
            const pageSequence = Array.from(document.querySelectorAll('.nav-item'))
                .filter(item => item.style.display !== 'none')
                .map(item => item.dataset.page);
            
            const currentIndex = pageSequence.indexOf(currentPageId);
            if (currentIndex === -1) return;

            if (deltaX < 0) { // Swipe Left
                const nextIndex = (currentIndex + 1) % pageSequence.length;
                switchPage(pageSequence[nextIndex]);
            } else { // Swipe Right
                const prevIndex = (currentIndex - 1 + pageSequence.length) % pageSequence.length;
                switchPage(pageSequence[prevIndex]);
            }
        }

        async function handleRefresh() {
            refreshIcon.classList.remove('ready-to-refresh');
            refreshIcon.classList.add('refreshing');
            await loadDataFromGoogleSheet(true);

            setTimeout(() => {
                ptrIndicator.classList.remove('visible');
                refreshIcon.classList.remove('refreshing');
                refreshIcon.style.transform = 'translateY(0px)';
                const svg = refreshIcon.querySelector('svg');
                if (svg) {
                    svg.style.transform = 'rotate(0deg)';
                }
            }, 500);
        }
    }

    // --- PDF & LINKING FUNCTIONS ---
    function downloadMonthlyReportPDF() {
        const url = "https://docs.google.com/spreadsheets/d/e/2PACX-1vQ71uzBxbU_fk8hPiGETaKuLFCVet6zoU-ikg3fP6LeHTbPd59ronYd4UPD24qfy-IKFBHyX_53T1rz/pub?gid=1935868&single=true&output=pdf";
        window.open(url, '_blank');
    }

    function generateParentReflectionPDF(student) {
        if (!student) return;
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF('p', 'pt', 'a4');
        
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(16);
        doc.text("Lembar Refleksi Orang Tua", doc.internal.pageSize.getWidth() / 2, 60, { align: 'center' });
        
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(12);
        doc.text(`Nama : ${student.name}`, 40, 90);
        doc.text(`Kelas : ${student.class}`, 40, 105);
        doc.text(`Bulan : _________________________`, 40, 120);

        let yPos = 150;

        habits.forEach(habit => {
            if (yPos > 680) { doc.addPage(); yPos = 40; }
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(11);
            doc.text(habit.name, 40, yPos);
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(10);
            doc.text("Kesimpulan/Refleksi:", 42, yPos + 20);
            doc.rect(40, yPos + 25, doc.internal.pageSize.getWidth() - 80, 50);
            doc.text("Tindak Lanjut:", 42, yPos + 90);
            doc.rect(40, yPos + 95, doc.internal.pageSize.getWidth() - 80, 50);
            yPos += 160;
        });

        if (yPos > 680) { doc.addPage(); yPos = 40; } else { yPos += 20; }
        
        const today = new Date();
        const formattedDate = today.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
        const marginRight = 40;
        const pageWidth = doc.internal.pageSize.getWidth();

        doc.setFontSize(10);
        doc.text(`${schoolData.city}, ${formattedDate}`, pageWidth - marginRight, yPos, { align: 'right' });
        
        yPos += 15;
        doc.text("Guru Kelas/Wali Kelas,", pageWidth - marginRight, yPos, { align: 'right' });
        doc.text("Orang Tua/Wali Murid,", 40, yPos);
        
        yPos += 50;
        doc.text(`(${schoolData.teacher})`, pageWidth - marginRight, yPos, { align: 'right' });
        doc.text("(___________________)", 40, yPos);
        
        doc.save(`refleksi-orang-tua-${student.nisn}.pdf`);
    }

    // --- SCHOOL DATA EDIT MODAL ---
    function showSchoolDataModal() {
        const modal = el('content-modal'); // Re-using the content modal container
        const title = 'Edit Data Sekolah';

        const formFields = `
            <div class="space-y-2">
                <label for="school-name-input" class="block text-sm font-medium">Nama Sekolah</label>
                <input type="text" id="school-name-input" value="${schoolData.name}" class="input-field" required>
            </div>
            <div class="space-y-2">
                <label for="school-npsn-input" class="block text-sm font-medium">NPSN</label>
                <input type="text" id="school-npsn-input" value="${schoolData.npsn}" class="input-field" required>
            </div>
            <div class="space-y-2">
                <label for="school-province-input" class="block text-sm font-medium">Provinsi</label>
                <input type="text" id="school-province-input" value="${schoolData.province}" class="input-field" required>
            </div>
            <div class="space-y-2">
                <label for="school-city-input" class="block text-sm font-medium">Kota/Kabupaten</label>
                <input type="text" id="school-city-input" value="${schoolData.city}" class="input-field" required>
            </div>
            <div class="space-y-2">
                <label for="school-headmaster-input" class="block text-sm font-medium">Nama Kepala Sekolah</label>
                <input type="text" id="school-headmaster-input" value="${schoolData.headmaster}" class="input-field" required>
            </div>
            <div class="space-y-2">
                <label for="school-headmasternip-input" class="block text-sm font-medium">NIP Kepala Sekolah</label>
                <input type="text" id="school-headmasternip-input" value="${schoolData.headmasterNip}" class="input-field" required>
            </div>
            <div class="space-y-2">
                <label for="school-teacher-input" class="block text-sm font-medium">Nama Guru</label>
                <input type="text" id="school-teacher-input" value="${schoolData.teacher}" class="input-field" required>
            </div>
        `;

        modal.innerHTML = `
            <div class="p-6 rounded-lg shadow-xl w-full max-w-sm modal-content max-h-[90vh] overflow-y-auto">
                <h2 class="text-xl font-bold mb-4">${title}</h2>
                <form id="school-data-form" class="space-y-4">
                    ${formFields}
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="el('content-modal').classList.add('hidden')" class="bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">Batal</button>
                        <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">Simpan</button>
                    </div>
                </form>
            </div>
        `;
        modal.classList.remove('hidden');
        el('school-data-form').addEventListener('submit', (e) => {
            e.preventDefault();
            handleSchoolDataSubmit();
        });
    }

    function handleSchoolDataSubmit() {
        // Read values from the modal form
        schoolData.name = el('school-name-input').value;
        schoolData.npsn = el('school-npsn-input').value;
        schoolData.province = el('school-province-input').value;
        schoolData.city = el('school-city-input').value;
        schoolData.headmaster = el('school-headmaster-input').value;
        schoolData.headmasterNip = el('school-headmasternip-input').value;
        schoolData.teacher = el('school-teacher-input').value;

        // In a real application, you would post this data to your server/backend.
        // For this example, the changes are only stored locally for the session.
        // e.g., await postData({ action: 'updateSchoolData', payload: schoolData });

        alert('Data sekolah berhasil diperbarui!');
        el('content-modal').classList.add('hidden');
    }
    
    function showContentModal(type, id = null) {
        const modal = el('content-modal');
        const isEdit = id !== null;
        const title = `${isEdit ? 'Edit' : 'Tambah'} ${type === 'video' ? 'Video' : 'Buku'}`;
        let item = {};
        let formFields = '';

        if (type === 'video') {
            if (isEdit) item = videoCollection[id];
            formFields = `
                <div class="space-y-2">
                    <label for="content-title" class="block text-sm font-medium">Judul Video</label>
                    <input type="text" id="content-title" value="${item.title || ''}" class="input-field" required>
                </div>
                <div class="space-y-2">
                    <label for="content-youtube-id" class="block text-sm font-medium">YouTube Video ID</label>
                    <input type="text" id="content-youtube-id" value="${item.youtubeId || ''}" class="input-field" required>
                </div>
            `;
        } else { // book
            if (isEdit) item = bookCollection[id];
            formFields = `
                <div class="space-y-2">
                    <label for="content-title" class="block text-sm font-medium">Judul Buku</label>
                    <input type="text" id="content-title" value="${item.title || ''}" class="input-field" required>
                </div>
                <div class="space-y-2">
                    <label for="content-url" class="block text-sm font-medium">URL Buku</label>
                    <input type="url" id="content-url" value="${item.url || ''}" class="input-field" required>
                </div>
                 <div class="space-y-2">
                    <label for="content-cover" class="block text-sm font-medium">URL Cover Buku</label>
                    <input type="url" id="content-cover" value="${item.cover || ''}" class="input-field" required>
                </div>
                <div class="space-y-2">
                    <label for="content-category" class="block text-sm font-medium">Kategori</label>
                    <input type="text" id="content-category" value="${item.category || ''}" class="input-field" required>
                </div>
                <div class="space-y-2">
                    <label for="content-description" class="block text-sm font-medium">Deskripsi</label>
                    <textarea id="content-description" class="input-field" rows="3" required>${item.description || ''}</textarea>
                </div>
            `;
        }

        modal.innerHTML = `
            <div class="p-6 rounded-lg shadow-xl w-full max-w-sm modal-content">
                <h2 class="text-xl font-bold mb-4">${title}</h2>
                <form id="content-form" class="space-y-4">
                    ${formFields}
                    <div class="flex justify-end gap-3 pt-4">
                        <button type="button" onclick="el('content-modal').classList.add('hidden')" class="bg-gray-200 dark:bg-gray-700 py-2 px-4 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">Batal</button>
                        <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">Simpan</button>
                    </div>
                </form>
            </div>
        `;
        modal.classList.remove('hidden');
        el('content-form').addEventListener('submit', (e) => {
            e.preventDefault();
            handleContentSubmit(type, id);
        });
    }

    async function handleContentSubmit(type, id) {
        const title = el('content-title').value;
        if (!title) {
            alert('Judul tidak boleh kosong.');
            return;
        }

        let newItem = { id: id || `${type.slice(0,1)}_${Date.now()}`, title };

        if (type === 'video') {
            const youtubeId = el('content-youtube-id').value;
            if (!youtubeId) { alert('YouTube ID tidak boleh kosong.'); return; }
            newItem.youtubeId = youtubeId;
            videoCollection[newItem.id] = newItem;
        } else { // book
            const url = el('content-url').value;
            const cover = el('content-cover').value;
            const category = el('content-category').value;
            const description = el('content-description').value;
            if (!url || !cover || !category || !description) { alert('Semua field buku harus diisi.'); return; }
            newItem.url = url;
            newItem.cover = cover;
            newItem.category = category;
            newItem.description = description;
            bookCollection[newItem.id] = newItem;
        }

        await postData({ action: 'saveContent', payload: { type: type, item: newItem }});
        el('content-modal').classList.add('hidden');
        renderKontenPage();
        if (el('page-book').classList.contains('active')) renderBookPage();
    }

    async function handleDeleteContent(type, id) {
        const userConfirmed = (prompt(`Apakah Anda yakin ingin menghapus item ini? Ketik 'YA' untuk konfirmasi.`) || '').toUpperCase() === 'YA';

        if (userConfirmed) {
            if (type === 'video') {
                delete videoCollection[id];
            } else { // book
                delete bookCollection[id];
            }
            await postData({ action: 'deleteContent', payload: { type: type, id: id }});
            renderKontenPage();
            if (el('page-video').classList.contains('active')) renderVideoPage();
            if (el('page-book').classList.contains('active')) renderBookPage();
        }
    }

    async function postData(body) {
        try {
            const res = await fetch(GOOGLE_SHEET_URL, {
                method: 'POST',
                redirect: 'follow',
                headers: { 'Content-Type': 'text/plain;charset=utf-8' },
                body: JSON.stringify(body)
            });
            return await res.json();
        } catch (error) {
            console.error('Failed to post data:', error);
            alert("Gagal menyimpan data ke server.");
            return { status: 'error', message: error.message };
        }
    }
    
    function timeAgo(dateStr) {
        // This function requires a valid date object or timestamp.
        // The original logic with parseSheetDate is removed for simplicity as it's not defined.
        // Using a direct timestamp assumption.
        const date = new Date(dateStr);
        if (isNaN(date.getTime())) return ""; // Return empty if date is invalid

        const seconds = Math.floor((new Date() - date) / 1000);
        if (seconds < 5) return "Baru saja";
        let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " tahun lalu";
        interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " bulan lalu";
        interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " hari lalu";
        interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " jam lalu";
        interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " menit lalu";
        return Math.floor(seconds) + " detik lalu";
    }
    
    function initializeNotifications() {
        // Notifications are temporary for now
    }

    function updateNotificationUI(hasNew) {
        if (hasNew) {
            el('notification-dot').classList.remove('hidden');
        }
    }
    
    function showNotificationPage() {
        const container = el('notification-page-container');
        if (!currentStudent) return;
        
        container.innerHTML = `
            <div class="w-full h-full flex flex-col modal-content">
                <div class="p-4 border-b flex items-center" style="border-color: var(--border-color)">
                    <button onclick="closeNotificationPage()" class="mr-4">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                    </button>
                    <h2 class="text-lg font-bold flex-grow">Notifikasi</h2>
                </div>
                <div id="notification-list" class="flex-grow overflow-y-auto p-2"></div>
            </div>
        `;
        renderNotifications();
        container.classList.remove('hidden', 'translate-x-full');
        el('notification-dot').classList.add('hidden');
    }

    function closeNotificationPage() {
        const container = el('notification-page-container');
        container.classList.add('translate-x-full');
        setTimeout(() => container.classList.add('hidden'), 300);
    }
    
    function renderNotifications() {
        const listContainer = el('notification-list');
        if (!currentStudent || !listContainer) return;
        
        const relevantNotifications = notifications.filter(notif => {
            if (notif.type === 'badge' && notif.actorName === currentStudent.name) return true;
            if (notif.type === 'like' && notif.postOwner.nisn === currentStudent.nisn) return true;
             if (notif.type === 'follow' && notif.followedNisn === currentStudent.nisn) return true;
            return false;
        }).sort((a,b) => b.timestamp - a.timestamp);
        
        if (relevantNotifications.length === 0) {
             listContainer.innerHTML = `<p class="text-center p-8" style="color: var(--text-secondary)">Tidak ada aktivitas terbaru.</p>`;
             return;
        }

        const groupNotificationsByTime = (notifications) => {
            const groups = { "Minggu Ini": [], "Bulan Ini": [], "Sebelumnya": [] };
            const now = new Date();
            const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());

            notifications.forEach(n => {
                const notifDate = n.timestamp;
                if (notifDate > oneWeekAgo) groups["Minggu Ini"].push(n);
                else if (notifDate > oneMonthAgo) groups["Bulan Ini"].push(n);
                else groups["Sebelumnya"].push(n);
            });
            return groups;
        };

        const grouped = groupNotificationsByTime(relevantNotifications);
        let contentHTML = '';

        for (const groupName in grouped) {
            if (grouped[groupName].length > 0) {
                contentHTML += `<h3 class="font-bold text-md p-2">${groupName}</h3>`;
                contentHTML += grouped[groupName].map(notif => {
                    let message = '';
                    let avatarUrl = notif.actor ? notif.actor.avatar : notif.actorAvatar;
                    if (notif.type === 'like') {
                        message = `<b>${notif.actor.name}</b> menyukai postingan Anda.`;
                    } else if (notif.type === 'follow') {
                        message = `<b>${notif.actor.name}</b> mulai mengikuti Anda.`;
                    } else if (notif.type === 'badge') {
                        message = `<b>Selamat!</b> Kamu baru saja mendapatkan semua lencana pencapaian.`;
                    }
                    return `
                    <div class="flex items-center gap-3 p-3 hover:bg-gray-50 dark:hover:bg-gray-800 rounded-lg">
                        <img src="${avatarUrl}" class="w-10 h-10 rounded-full">
                        <p class="text-sm flex-grow">${message}</p>
                        <span class="text-xs" style="color: var(--text-secondary)">${timeAgo(notif.timestamp)}</span>
                    </div>`;
                }).join('');
            }
        }
        listContainer.innerHTML = contentHTML;
    }
    
    </script>
</body>
</html>
