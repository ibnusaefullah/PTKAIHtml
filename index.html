<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>7 KAIH - Menu Modern</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts: Poppins -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- jsPDF Library for PDF Generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf-autotable.min.js"></script>


    <style>
        body { 
            font-family: 'Poppins', sans-serif; 
            background-color: #f0f2f5; 
        }
        #app-container {
            display: none;
        }
        .page {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        .page.active {
            display: block;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .bottom-nav {
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }
        .nav-item.active .nav-text {
            color: #1D4ED8; /* blue-700 */
            font-weight: 600;
        }
        .nav-item.active svg {
            transform: scale(1.1);
            color: #1D4ED8; /* blue-700 */
        }
        .nav-item svg {
            transition: all 0.2s ease-in-out;
        }
        .input-field { background-color: #FAFAFA; border: 1px solid #DBDBDB; border-radius: 6px; padding: 10px; width: 100%; }
        .toggle-checkbox:checked { right: 0; border-color: #3897f0; }
        .toggle-checkbox:checked + .toggle-label { background-color: #3897f0; }
        .loader { border: 4px solid #f3f3f3; border-radius: 50%; border-top: 4px solid #3498db; width: 40px; height: 40px; animation: spin 2s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .follow-btn {
            padding: 4px 12px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 12px;
            transition: all 0.2s ease-in-out;
        }
        .follow-btn.following {
             background-color: #E5E7EB; /* gray-200 */
             color: #374151; /* gray-700 */
        }
         .follow-btn.not-following {
            background-color: #3B82F6; /* blue-500 */
            color: white;
        }
        .badge {
            transition: transform 0.2s ease-in-out;
        }
        .badge:hover {
            transform: scale(1.1);
        }
        #notification-page-container {
            transition: transform 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Container for the entire application -->
    <div class="max-w-md mx-auto h-screen bg-white shadow-lg relative flex flex-col">

        <!-- Initial Loading View -->
        <div id="loading-view" class="flex flex-col items-center justify-center h-full">
            <div class="loader"></div>
            <p class="mt-4 text-gray-600">Memuat data...</p>
        </div>

        <!-- App Container (Main structure) -->
        <div id="app-container" class="h-full flex flex-col">
            <header id="app-header" class="p-4 flex justify-between items-center border-b border-gray-200 bg-white z-10">
                <h1 id="header-title" class="text-xl font-bold text-gray-800">Beranda</h1>
                 <button id="notification-btn" class="relative text-gray-600 hover:text-red-500 transition-colors">
                     <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                       <path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" />
                     </svg>
                     <span id="notification-dot" class="hidden absolute top-0 right-0 block h-2.5 w-2.5 rounded-full bg-red-500 ring-2 ring-white"></span>
                 </button>
            </header>
            <main class="flex-grow overflow-y-auto bg-gray-50">
                <div id="page-home" class="page p-4"></div>
                <div id="page-video" class="page p-4"></div>
                <div id="page-book" class="page p-4"></div>
                <div id="page-report" class="page p-4"></div>
                <div id="page-konten" class="page p-4"></div> <!-- New page for admin content -->
                <div id="page-profile" class="page p-4"></div>
            </main>
            <nav class="bottom-nav w-full bg-white p-2 border-t border-gray-200">
                          <div class="flex justify-around items-center">
                              <button class="nav-item flex-1 flex flex-col items-center p-2 text-gray-500 hover:text-blue-700 transition-colors active" data-page="home"><span class="text-xs nav-text">Beranda</span></button>
                              <button class="nav-item flex-1 flex flex-col items-center p-2 text-gray-500 hover:text-blue-700 transition-colors" data-page="video"><span class="text-xs nav-text">Video</span></button>
                              <button class="nav-item flex-1 flex flex-col items-center p-2 text-gray-500 hover:text-blue-700 transition-colors" data-page="book"><span class="text-xs nav-text">Buku</span></button>
                              <button id="nav-item-report" class="nav-item flex-1 flex flex-col items-center p-2 text-gray-500 hover:text-blue-700 transition-colors" data-page="report"><span class="text-xs nav-text">Laporan</span></button>
                              <button id="nav-item-konten" class="nav-item flex-1 flex flex-col items-center p-2 text-gray-500 hover:text-blue-700 transition-colors" data-page="konten" style="display: none;"><span class="text-xs nav-text">Konten</span></button>
                              <button class="nav-item flex-1 flex flex-col items-center p-2 text-gray-500 hover:text-blue-700 transition-colors" data-page="profile"><span class="text-xs nav-text">Profil</span></button>
                          </div>
            </nav>
        </div>
    </div>

    <!-- Modals -->
    <div id="login-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4"></div>
    <div id="content-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4"></div>
    <div id="badge-details-modal" class="hidden fixed inset-0 bg-black bg-opacity-60 z-50 flex items-center justify-center p-4"></div>
    <div id="notification-page-container" class="hidden fixed inset-0 bg-white z-50 transform translate-x-full"></div>

    <script>
        // --- ICON DEFINITIONS (Modern Instagram Style) ---
        const icons = {
            home: {
                outline: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>`,
                filled: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M10.707 2.293a1 1 0 00-1.414 0l-7 7a1 1 0 001.414 1.414L4 10.414V17a1 1 0 001 1h2a1 1 0 001-1v-2a1 1 0 011-1h2a1 1 0 011 1v2a1 1 0 001 1h2a1 1 0 001-1v-6.586l.293.293a1 1 0 001.414-1.414l-7-7z" /></svg>`
            },
            video: {
                outline: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" /><path stroke-linecap="round" stroke-linejoin="round" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`,
                filled: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8.134v3.732a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664l-3.197-2.132z" clip-rule="evenodd" /></svg>`
            },
            book: {
                outline: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z" /></svg>`,
                filled: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M5 4a2 2 0 012-2h6a2 2 0 012 2v14l-5-2.5L5 18V4z" /></svg>`
            },
            report: {
                outline: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>`,
                filled: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path d="M9 2a1 1 0 000 2h2a1 1 0 100-2H9z" /><path fill-rule="evenodd" d="M4 5a2 2 0 012-2 3 3 0 003 3h2a3 3 0 003-3 2 2 0 012 2v11a2 2 0 01-2 2H6a2 2 0 01-2-2V5zm3 4a1 1 0 000 2h.01a1 1 0 100-2H7zm3 0a1 1 0 000 2h3a1 1 0 100-2h-3zm-3 4a1 1 0 100 2h.01a1 1 0 100-2H7zm3 0a1 1 0 100 2h3a1 1 0 100-2h-3z" clip-rule="evenodd" /></svg>`
            },
            konten: {
                outline: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>`,
                filled: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H5a2 2 0 01-2-2V5zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM3 13a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H5a2 2 0 01-2-2v-2zm10 0a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" clip-rule="evenodd" /></svg>`
            },
            profile: {
                outline: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z" /></svg>`,
                filled: `<svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-6-3a2 2 0 11-4 0 2 2 0 014 0zm-2 4a5 5 0 00-4.546 2.916A5.986 5.986 0 0010 16a5.986 5.986 0 004.546-2.084A5 5 0 0012 11z" clip-rule="evenodd" /></svg>`
            }
        };

        // --- KONFIGURASI ---
        const schoolData = {
            name: "SDN Contoh 1",
            npsn: "12345678",
            province: "Jawa Barat",
            city: "Indramayu",
            headmaster: "Dr. H. Sutrisno, M.Pd.",
            headmasterNip: "196504051988031011",
            teacher: "Asep Surasep, S.Pd.",
        };
        const localAdmin = { username: 'guru', password: '1234' };
        
        // --- UPDATED DATA ---
        let localStudentDatabase = { 
            "12345": { 
                name: "Budi", 
                class: "5", 
                following: ["54321"], 
                followers: [], 
                achievements: { 
                    "Bangun Pagi": ["2025-06-27", "2025-06-26", "2025-06-25", "2025-06-24", "2025-06-23", "2025-06-22", "2025-06-21", "2025-06-20", "2025-06-19", "2025-06-18", "2025-06-17", "2025-06-16", "2025-06-15", "2025-06-14", "2025-06-13", "2025-06-12", "2025-06-11", "2025-06-10", "2025-06-09", "2025-06-08", "2025-06-07"],
                    "Taat Beribadah": ["2025-06-27", "2025-06-26", "2025-06-25", "2025-06-24", "2025-06-23", "2025-06-22", "2025-06-21", "2025-06-20", "2025-06-19", "2025-06-18", "2025-06-17", "2025-06-16", "2025-06-15", "2025-06-14", "2025-06-13", "2025-06-12", "2025-06-11", "2025-06-10", "2025-06-09", "2025-06-08", "2025-06-07"],
                    "Berolahraga": ["2025-06-26", "2025-06-24", "2025-06-22", "2025-06-21", "2025-06-19", "2025-06-17", "2025-06-15", "2025-06-13", "2025-06-11", "2025-06-09", "2025-06-07"],
                    "Makan Sehat": ["2025-06-27", "2025-06-26", "2025-06-25", "2025-06-24", "2025-06-23", "2025-06-22", "2025-06-21", "2025-06-20", "2025-06-19", "2025-06-18", "2025-06-17", "2025-06-16", "2025-06-15", "2025-06-14", "2025-06-13", "2025-06-12", "2025-06-11", "2025-06-10", "2025-06-09", "2025-06-08", "2025-06-07"],
                    "Gemar Belajar": ["2025-06-27", "2025-06-26", "2025-06-25", "2025-06-24", "2025-06-23", "2025-06-20", "2025-06-19", "2025-06-18", "2025-06-17", "2025-06-16", "2025-06-13", "2025-06-12", "2025-06-11", "2025-06-10", "2025-06-09"],
                    "Aktif Bermasyarakat": ["2025-06-22", "2025-06-21", "2025-06-15", "2025-06-14", "2025-06-08", "2025-06-07"],
                    "Tidur Cepat": ["2025-06-26", "2025-06-25", "2025-06-24", "2025-06-23", "2025-06-22", "2025-06-19", "2025-06-18", "2025-06-17", "2025-06-16", "2025-06-15", "2025-06-12", "2025-06-11", "2025-06-10", "2025-06-09", "2025-06-08"]
                }, 
                avatar: "https://placehold.co/100x100/3B82F6/FFFFFF?text=B" 
            }, 
            "54321": { name: "Ani", class: "6", following: [], followers: ["12345"], achievements: {}, avatar: "https://placehold.co/100x100/EC4899/FFFFFF?text=A" },
            "11223": { name: "Cici", class: "5", following: [], followers: [], achievements: {}, avatar: "https://placehold.co/100x100/10B981/FFFFFF?text=C" },
            "33445": { name: "Dedi", class: "6", following: [], followers: [], achievements: {}, avatar: "https://placehold.co/100x100/F59E0B/FFFFFF?text=D" }
        };
        let localVideoCollection = [{id: 'vid_1', title: 'Senam Anak Indonesia Hebat', youtubeId: 'yobwi89woPQ'}];
        let localBookCollection = [{id: 'book_1', title: 'Buku Contoh', url: '#', cover: 'https://placehold.co/100x140/3B82F6/FFFFFF?text=Buku'}];
        let activityFeed = [
            // Sample data for Ani
            { id: 'act_4', nisn: "54321", name: "Ani", class: "6", date: "28 Juni 2025", completedHabits: ["Berolahraga", "Gemar Belajar"], avatar: localStudentDatabase["54321"].avatar, likes: 10, likedBy: [] },
            
            // --- DATA BUDI 3 MINGGU ---
            { id: 'act_budi_20250607', nisn: "12345", name: "Budi", class: "5", date: "07 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Berolahraga", "Aktif Bermasyarakat"], avatar: localStudentDatabase["12345"].avatar, likes: 7, likedBy: [] },
            { id: 'act_budi_20250608', nisn: "12345", name: "Budi", class: "5", date: "08 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Tidur Cepat", "Aktif Bermasyarakat"], avatar: localStudentDatabase["12345"].avatar, likes: 5, likedBy: [] },
            { id: 'act_budi_20250609', nisn: "12345", name: "Budi", class: "5", date: "09 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Gemar Belajar", "Tidur Cepat", "Berolahraga"], avatar: localStudentDatabase["12345"].avatar, likes: 12, likedBy: ["54321"] },
            { id: 'act_budi_20250610', nisn: "12345", name: "Budi", class: "5", date: "10 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Gemar Belajar", "Tidur Cepat"], avatar: localStudentDatabase["12345"].avatar, likes: 8, likedBy: [] },
            { id: 'act_budi_20250611', nisn: "12345", name: "Budi", class: "5", date: "11 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Berolahraga", "Gemar Belajar", "Tidur Cepat"], avatar: localStudentDatabase["12345"].avatar, likes: 15, likedBy: ["11223"] },
            { id: 'act_budi_20250612', nisn: "12345", name: "Budi", class: "5", date: "12 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Gemar Belajar", "Tidur Cepat"], avatar: localStudentDatabase["12345"].avatar, likes: 9, likedBy: [] },
            { id: 'act_budi_20250613', nisn: "12345", name: "Budi", class: "5", date: "13 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Berolahraga", "Gemar Belajar"], avatar: localStudentDatabase["12345"].avatar, likes: 11, likedBy: [] },
            { id: 'act_budi_20250614', nisn: "12345", name: "Budi", class: "5", date: "14 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Aktif Bermasyarakat"], avatar: localStudentDatabase["12345"].avatar, likes: 6, likedBy: [] },
            { id: 'act_budi_20250615', nisn: "12345", name: "Budi", class: "5", date: "15 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Berolahraga", "Tidur Cepat", "Aktif Bermasyarakat"], avatar: localStudentDatabase["12345"].avatar, likes: 10, likedBy: ["54321"] },
            { id: 'act_budi_20250616', nisn: "12345", name: "Budi", class: "5", date: "16 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Gemar Belajar", "Tidur Cepat"], avatar: localStudentDatabase["12345"].avatar, likes: 8, likedBy: [] },
            { id: 'act_budi_20250617', nisn: "12345", name: "Budi", class: "5", date: "17 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Berolahraga", "Makan Sehat", "Gemar Belajar", "Tidur Cepat"], avatar: localStudentDatabase["12345"].avatar, likes: 14, likedBy: ["11223"] },
            { id: 'act_budi_20250618', nisn: "12345", name: "Budi", class: "5", date: "18 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Gemar Belajar", "Tidur Cepat"], avatar: localStudentDatabase["12345"].avatar, likes: 7, likedBy: [] },
            { id: 'act_budi_20250619', nisn: "12345", name: "Budi", class: "5", date: "19 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Berolahraga", "Gemar Belajar", "Tidur Cepat"], avatar: localStudentDatabase["12345"].avatar, likes: 13, likedBy: [] },
            { id: 'act_budi_20250620', nisn: "12345", name: "Budi", class: "5", date: "20 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Gemar Belajar"], avatar: localStudentDatabase["12345"].avatar, likes: 9, likedBy: ["54321"] },
            { id: 'act_budi_20250621', nisn: "12345", name: "Budi", class: "5", date: "21 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Berolahraga", "Aktif Bermasyarakat"], avatar: localStudentDatabase["12345"].avatar, likes: 8, likedBy: [] },
            { id: 'act_budi_20250622', nisn: "12345", name: "Budi", class: "5", date: "22 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Tidur Cepat", "Aktif Bermasyarakat"], avatar: localStudentDatabase["12345"].avatar, likes: 6, likedBy: [] },
            { id: 'act_budi_20250623', nisn: "12345", name: "Budi", class: "5", date: "23 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Gemar Belajar", "Tidur Cepat"], avatar: localStudentDatabase["12345"].avatar, likes: 11, likedBy: [] },
            { id: 'act_budi_20250624', nisn: "12345", name: "Budi", class: "5", date: "24 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Berolahraga", "Gemar Belajar", "Tidur Cepat"], avatar: localStudentDatabase["12345"].avatar, likes: 16, likedBy: ["54321", "11223"] },
            { id: 'act_budi_20250625', nisn: "12345", name: "Budi", class: "5", date: "25 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Gemar Belajar", "Tidur Cepat"], avatar: localStudentDatabase["12345"].avatar, likes: 10, likedBy: [] },
            { id: 'act_budi_20250626', nisn: "12345", name: "Budi", class: "5", date: "26 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Berolahraga", "Gemar Belajar", "Tidur Cepat"], avatar: localStudentDatabase["12345"].avatar, likes: 14, likedBy: [] },
            { id: 'act_budi_20250627', nisn: "12345", name: "Budi", class: "5", date: "27 Juni 2025", completedHabits: ["Bangun Pagi", "Taat Beribadah", "Makan Sehat", "Gemar Belajar"], avatar: localStudentDatabase["12345"].avatar, likes: 12, likedBy: ["54321"] }
        ];
        
        const habits = [
            { name: "Bangun Pagi", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" /></svg>`, hasTimeInput: true },
            { name: "Taat Beribadah", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M5.636 18.364a9 9 0 010-12.728m12.728 0a9 9 0 010 12.728m-9.9-2.829a5 5 0 010-7.07m7.072 0a5 5 0 010 7.07M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>` },
            { name: "Berolahraga", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>` },
            { name: "Makan Sehat", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>` },
            { name: "Gemar Belajar", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>` },
            { name: "Aktif Bermasyarakat", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" /></svg>` },
            { name: "Tidur Cepat", icon: `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" /></svg>`, hasTimeInput: true }
        ];

        const badges = [
            { name: "Bangun Pagi", description: "Disiplin memulai hari lebih awal!", 
              unlockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><defs><linearGradient id="grad-sun" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FFD147"/><stop offset="100%" stop-color="#FFAB2E"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#grad-sun)"/><g fill="#FFF" opacity="0.9"><path d="M32 20a2 2 0 012 2v2a2 2 0 11-4 0v-2a2 2 0 012-2zM45.6 25.4a2 2 0 012.8 0l1.4 1.4a2 2 0 11-2.8 2.8l-1.4-1.4a2 2 0 010-2.8zM18.4 25.4a2 2 0 010 2.8l-1.4 1.4a2 2 0 11-2.8-2.8l1.4-1.4a2 2 0 012.8 0zM24 46h16a2 2 0 110 4H24a2 2 0 110-4z"/></g><circle cx="32" cy="32" r="8" fill="#FFF"/></svg>`,
              lockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><circle cx="32" cy="32" r="30" fill="#E0E0E0"/><path d="M32 20a2 2 0 012 2v2a2 2 0 11-4 0v-2a2 2 0 012-2zM45.6 25.4a2 2 0 012.8 0l1.4 1.4a2 2 0 11-2.8 2.8l-1.4-1.4a2 2 0 010-2.8zM18.4 25.4a2 2 0 010 2.8l-1.4 1.4a2 2 0 11-2.8-2.8l1.4-1.4a2 2 0 012.8 0zM24 46h16a2 2 0 110 4H24a2 2 0 110-4z" fill="#BDBDBD"/><circle cx="32" cy="32" r="8" fill="#BDBDBD"/></svg>`},
            { name: "Taat Beribadah", description: "Selalu mendekatkan diri pada Tuhan.", 
              unlockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><defs><linearGradient id="grad-pray" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#55C8FF"/><stop offset="100%" stop-color="#3A8DFF"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#grad-pray)"/><path d="M22 36l10-16 10 16H22zm0 4h20v4H22v-4z" fill="#FFF" opacity="0.9"/></svg>`, 
              lockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><circle cx="32" cy="32" r="30" fill="#E0E0E0"/><path d="M22 36l10-16 10 16H22zm0 4h20v4H22v-4z" fill="#BDBDBD"/></svg>`},
            { name: "Berolahraga", description: "Menjaga tubuh kuat dan sehat!", 
              unlockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><defs><linearGradient id="grad-sport" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FF7B7B"/><stop offset="100%" stop-color="#FF5252"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#grad-sport)"/><path d="M21 28l9-9 5 5-9 9-5-5zm13 0l5-5 5 5-5 5-5-5z" fill="#FFF" opacity="0.9"/></svg>`, 
              lockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><circle cx="32" cy="32" r="30" fill="#E0E0E0"/><path d="M21 28l9-9 5 5-9 9-5-5zm13 0l5-5 5 5-5 5-5-5z" fill="#BDBDBD"/></svg>`},
            { name: "Makan Sehat", description: "Energi hebat dari makanan sehat!", 
              unlockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><defs><linearGradient id="grad-food" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#76E236"/><stop offset="100%" stop-color="#36C23D"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#grad-food)"/><path d="M20 28c0-4.4 3.6-8 8-8h8c4.4 0 8 3.6 8 8v8c0 4.4-3.6 8-8 8h-8c-4.4 0-8-3.6-8-8v-8zm4 0v8c0 2.2 1.8 4 4 4h8c2.2 0 4-1.8 4-4v-8c0-2.2-1.8-4-4-4h-8c-2.2 0-4 1.8-4 4z" fill="#FFF" opacity="0.9"/><circle cx="28" cy="32" r="3" fill="#FFF"/><circle cx="36" cy="32" r="3" fill="#FFF"/></svg>`, 
              lockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><circle cx="32" cy="32" r="30" fill="#E0E0E0"/><path d="M20 28c0-4.4 3.6-8 8-8h8c4.4 0 8 3.6 8 8v8c0 4.4-3.6 8-8 8h-8c-4.4 0-8-3.6-8-8v-8zm4 0v8c0 2.2 1.8 4 4 4h8c2.2 0 4-1.8 4-4v-8c0-2.2-1.8-4-4-4h-8c-2.2 0-4 1.8-4 4z" fill="#BDBDBD"/><circle cx="28" cy="32" r="3" fill="#BDBDBD"/><circle cx="36" cy="32" r="3" fill="#BDBDBD"/></svg>`},
            { name: "Gemar Belajar", description: "Ilmu adalah jendela dunia.", 
              unlockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><defs><linearGradient id="grad-learn" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#8E54E9"/><stop offset="100%" stop-color="#4776E6"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#grad-learn)"/><path d="M20 22h24v4H20v-4zm0 8h24v4H20v-4zm0 8h16v4H20v-4z" fill="#FFF" opacity="0.9"/></svg>`, 
              lockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><circle cx="32" cy="32" r="30" fill="#E0E0E0"/><path d="M20 22h24v4H20v-4zm0 8h24v4H20v-4zm0 8h16v4H20v-4z" fill="#BDBDBD"/></svg>`},
            { name: "Aktif Bermasyarakat", description: "Peduli dan bermanfaat bagi sesama.", 
              unlockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><defs><linearGradient id="grad-social" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#FF63A6"/><stop offset="100%" stop-color="#E14698"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#grad-social)"/><circle cx="24" cy="26" r="6" fill="#FFF" opacity="0.9"/><path d="M18 42c0-3.3 2.7-6 6-6s6 2.7 6 6v2H18v-2z" fill="#FFF" opacity="0.9"/><circle cx="40" cy="26" r="6" fill="#FFF" opacity="0.9"/><path d="M34 42c0-3.3 2.7-6 6-6s6 2.7 6 6v2H34v-2z" fill="#FFF" opacity="0.9"/></svg>`, 
              lockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><circle cx="32" cy="32" r="30" fill="#E0E0E0"/><circle cx="24" cy="26" r="6" fill="#BDBDBD"/><path d="M18 42c0-3.3 2.7-6 6-6s6 2.7 6 6v2H18v-2z" fill="#BDBDBD"/><circle cx="40" cy="26" r="6" fill="#BDBDBD"/><path d="M34 42c0-3.3 2.7-6 6-6s6 2.7 6 6v2H34v-2z" fill="#BDBDBD"/></svg>`},
            { name: "Tidur Cepat", description: "Istirahat cukup untuk hari yang produktif.", 
              unlockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><defs><linearGradient id="grad-sleep" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" stop-color="#4C5C96"/><stop offset="100%" stop-color="#2C3A70"/></linearGradient></defs><circle cx="32" cy="32" r="30" fill="url(#grad-sleep)"/><path d="M44 24c0 6.6-5.4 12-12 12S20 30.6 20 24c0-5.5 3.7-10.1 8.5-11.5.8-.2 1.5.4 1.5 1.2v20.6c0 .8.9 1.3 1.6.8 4.4-3.1 7.4-8 7.4-13.1z" fill="#FFF" opacity="0.9"/><g fill="#FFF" opacity="0.7"><circle cx="22" cy="20" r="2"/><circle cx="20" cy="28" r="1.5"/><circle cx="24" cy="36" r="2"/></g></svg>`, 
              lockedIcon: `<svg viewBox="0 0 64 64" class="w-12 h-12"><circle cx="32" cy="32" r="30" fill="#E0E0E0"/><path d="M44 24c0 6.6-5.4 12-12 12S20 30.6 20 24c0-5.5 3.7-10.1 8.5-11.5.8-.2 1.5.4 1.5 1.2v20.6c0 .8.9 1.3 1.6.8 4.4-3.1 7.4-8 7.4-13.1z" fill="#BDBDBD"/><g fill="#BDBDBD" opacity="0.7"><circle cx="22" cy="20" r="2"/><circle cx="20" cy="28" r="1.5"/><circle cx="24" cy="36" r="2"/></g></svg>`},
        ];

        // --- GLOBAL STATE ---
        let videoCollection = [];
        let bookCollection = [];
        let studentDatabase = {};
        let currentStudent = null;
        let currentAdmin = null;
        let notifications = []; 
        let hasUnreadNotifications = false;

        // --- MAIN ELEMENTS ---
        const el = id => document.getElementById(id);
        const loadingView = el('loading-view');
        const appContainer = el('app-container');

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            videoCollection = localVideoCollection;
            bookCollection = localBookCollection;
            studentDatabase = localStudentDatabase;
            initializeNotifications();
            loadingView.style.display = 'none';
            appContainer.style.display = 'flex';  
            setupEventListeners();
            updateNavVisibility(); 
            switchPage('home');
        });
        
        function insertIcons() {
            document.querySelectorAll('.nav-item').forEach(item => {
                const pageId = item.dataset.page;
                const iconSet = icons[pageId];
                if (iconSet && !item.querySelector('svg')) { 
                    item.insertAdjacentHTML('afterbegin', iconSet.outline); 
                }
            });
        }

        function setupEventListeners() {
            document.querySelectorAll('.nav-item').forEach(item => { item.addEventListener('click', () => switchPage(item.dataset.page)); });
            el('notification-btn').addEventListener('click', showNotificationPage);
        }
        
        // --- DISPLAY CONTROL ---
        function switchPage(pageId) {
            insertIcons(); 
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
                const iconId = item.dataset.page;
                const iconSet = icons[iconId];
                const existingIcon = item.querySelector('svg');
                if (existingIcon) existingIcon.remove();
                if(iconSet) item.insertAdjacentHTML('afterbegin', iconSet.outline);
                 if (item.dataset && item.dataset.page === pageId) {
                     item.classList.add('active');
                     el('header-title').textContent = item.querySelector('.nav-text').textContent;
                     const activeIcon = item.querySelector('svg');
                     if (activeIcon) activeIcon.remove();
                     if(iconSet) item.insertAdjacentHTML('afterbegin', iconSet.filled);
                 }
            });
            const newPage = el(`page-${pageId}`);
            if (newPage) newPage.classList.add('active');
            if (pageId === 'home') renderHomePage();
            if (pageId === 'video') renderVideoPage();
            if (pageId === 'book') renderBookPage();
            if (pageId === 'report') renderReportPage();
            if (pageId === 'konten') renderKontenPage();
            if (pageId === 'profile') renderProfilePage();
        }

        function updateNavVisibility() {
            const reportButton = el('nav-item-report');
            const kontenButton = el('nav-item-konten');
            
            if (currentStudent) {
                reportButton.style.display = 'flex';
                kontenButton.style.display = 'none';
            } else if (currentAdmin) {
                reportButton.style.display = 'none';
                kontenButton.style.display = 'flex';
            } else { 
                reportButton.style.display = 'none';
                kontenButton.style.display = 'none';
            }
        }
        
        // --- PAGE RENDERING ---
        function renderHomePage() {
            const homePage = el('page-home');
            let contentHTML = '';

            if (!currentStudent) {
                 homePage.innerHTML = `<div class="text-center mt-8 p-4"><p class="text-gray-500">Silakan login untuk melihat feed aktivitas dan mengikuti teman Anda.</p><button onclick="switchPage('profile')" class="mt-4 bg-blue-500 text-white py-2 px-4 rounded-lg">Ke Halaman Profil</button></div>`;
                 return;
            }

            const followingList = currentStudent.following || [];
            // Show posts from people the user follows, plus their own posts.
            const feed = activityFeed.filter(act => followingList.includes(act.nisn) || act.nisn === currentStudent.nisn);
            
            // Sort feed by date, newest first
            feed.sort((a, b) => {
                const dateA = new Date(a.date.split(' ').reverse().join('-').replace(/Juni/g, 'June'));
                const dateB = new Date(b.date.split(' ').reverse().join('-').replace(/Juni/g, 'June'));
                return dateB - dateA;
            });


            if (feed.length === 0) {
                 contentHTML += `<p class="text-center text-gray-500 mt-8">Feed Anda sepi. Ikuti teman untuk melihat aktivitas mereka di sini.</p>`;
            } else {
                 contentHTML += feed.map(activity => renderActivityCard(activity)).join('');
            }
            
            // Suggestions
            const suggestions = Object.entries(studentDatabase)
                .filter(([nisn, student]) => nisn !== currentStudent.nisn && !followingList.includes(nisn))
                .slice(0, 5); // Limit to 5 suggestions

            if(suggestions.length > 0){
                contentHTML += `
                    <div class="mt-8">
                        <h3 class="font-bold text-gray-700 mb-2">Saran untuk Anda</h3>
                        <div class="bg-white border border-gray-200 rounded-lg p-2 space-y-2">
                            ${suggestions.map(([nisn, student]) => `
                                <div class="flex items-center justify-between p-2">
                                    <div class="flex items-center gap-3">
                                        <img src="${student.avatar}" onerror="this.src='https://placehold.co/100x100/CCCCCC/FFFFFF?text=Err'" class="w-10 h-10 rounded-full">
                                        <div>
                                            <p class="font-bold text-sm">${student.name}</p>
                                            <p class="text-xs text-gray-500">Siswa Kelas ${student.class}</p>
                                        </div>
                                    </div>
                                    <button onclick="handleFollowToggle('${nisn}')" class="follow-btn not-following">Ikuti</button>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }

            homePage.innerHTML = contentHTML;
        }
        
        function renderActivityCard(activity) {
            const isOwnPost = currentStudent && currentStudent.nisn === activity.nisn;
            const isFollowing = currentStudent && currentStudent.following.includes(activity.nisn);

            let followButtonHTML = '';
            if (currentStudent && !isOwnPost) {
                const buttonClass = isFollowing ? 'following' : 'not-following';
                const buttonText = isFollowing ? 'Mengikuti' : 'Ikuti';
                followButtonHTML = `<button onclick="handleFollowToggle('${activity.nisn}')" class="follow-btn ${buttonClass}">${buttonText}</button>`;
            }

            return `
                <div class="bg-white border border-gray-200 rounded-lg mb-4 shadow-sm">
                    <div class="flex items-center justify-between p-3 border-b border-gray-200">
                        <div class="flex items-center">
                           <img src="${activity.avatar}" onerror="this.src='https://placehold.co/100x100/CCCCCC/FFFFFF?text=Err'" class="w-8 h-8 rounded-full mr-3">
                           <div><p class="font-bold text-sm">${activity.name}</p><p class="text-xs text-gray-500">Kelas ${activity.class}</p></div>
                        </div>
                        ${followButtonHTML}
                    </div>
                    <div class="p-4">
                        <p class="text-xs text-gray-500 mb-2">${activity.date}</p>
                        <p class="font-semibold text-sm mb-2">Telah menyelesaikan:</p>
                        <ul class="list-disc list-inside space-y-1 text-sm text-gray-700">
                            ${activity.completedHabits.map(habit => `<li>${habit}</li>`).join('')}
                        </ul>
                        <div class="flex items-center mt-4 justify-end">
                            <button onclick="handleLikePost('${activity.id}')" class="flex items-center space-x-1 text-sm ${currentStudent && activity.likedBy.includes(currentStudent.nisn) ? 'text-red-500' : 'text-gray-400'} hover:text-red-500 transition-colors">
                                ${currentStudent && activity.likedBy.includes(currentStudent.nisn)
                                    ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3.172 5.172a4 4 0 015.656 0L10 6.343l1.172-1.171a4 4 0 115.656 5.656L10 17.657l-6.828-6.829a4 4 0 010-5.656z" clip-rule="evenodd" /></svg>`
                                    : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4.318 6.318a4.5 4.5 0 000 6.364L12 20.364l7.682-7.682a4.5 4.5 0 00-6.364-6.364L12 7.636l-1.318-1.318a4.5 4.5 0 00-6.364 0z" /></svg>`
                                }
                                <span class="font-semibold">${activity.likes}</span>
                            </button>
                        </div>
                    </div>
                </div>`;
        }


        function renderVideoPage() {
             const videoPage = el('page-video');
               if (videoCollection.length === 0) {
                   videoPage.innerHTML = `<p class="text-center text-gray-500 mt-8">Belum ada video yang tersedia.</p>`; return;
               }
               videoPage.innerHTML = `<div class="grid grid-cols-1 gap-4">${videoCollection.map(video => `<div class="bg-white rounded-lg shadow-sm overflow-hidden"><div class="relative w-full aspect-video bg-gray-300 flex items-center justify-center"><iframe class="w-full h-full" src="https://www.youtube.com/embed/${video.youtubeId}" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe></div><div class="p-4"><h3 class="font-semibold text-gray-800">${video.title}</h3><p class="text-sm text-gray-500">Video pembelajaran</p></div></div>`).join('')}</div>`;
        }
        function renderBookPage() {
            const bookPage = el('page-book');
            if (bookCollection.length === 0) {
                bookPage.innerHTML = `<p class="text-center text-gray-500 mt-8">Belum ada buku yang tersedia.</p>`; return;
            }
            bookPage.innerHTML = `<div class="grid grid-cols-2 sm:grid-cols-3 gap-4">${bookCollection.map(book => `<div class="bg-white rounded-lg shadow-sm overflow-hidden"><img src="${book.cover}" onerror="this.src='https://placehold.co/200x280/CCCCCC/FFFFFF?text=No+Image'" alt="Cover Buku" class="w-full h-auto object-cover aspect-[5/7] rounded-t-lg"><div class="p-3 text-center"><h3 class="font-semibold text-sm text-gray-800 truncate">${book.title}</h3><a href="${book.url}" target="_blank" class="block mt-2 text-blue-500 hover:underline text-xs">Baca Buku</a></div></div>`).join('')}</div>`;
        }
        
        function renderProfilePage() {
            const profilePage = el('page-profile');
            
            if(currentStudent) {
                 const studentData = studentDatabase[currentStudent.nisn];
                 const achievements = studentData.achievements || {};

                 let badgeHTML = `
                     <div class="bg-white rounded-xl shadow-sm p-4">
                         <h3 class="text-sm font-bold text-gray-800 mb-2">Lencana Sekolah BRIDE</h3>
                         <div class="grid grid-cols-4 gap-4">
               `;
                
                 badgeHTML += badges.map(badge => {
                     const habitAchievements = achievements[badge.name] || [];
                     const isUnlocked = habitAchievements.length > 0;
                     const icon = isUnlocked ? badge.unlockedIcon : badge.lockedIcon;
                     const clickAction = isUnlocked ? `showBadgeDetailsModal('${badge.name}')` : `showToastNotification('info', 'Lencana terkunci. Selesaikan kebiasaan ini untuk membuka!')`;
                     return `
                         <div onclick="${clickAction}" class="badge flex flex-col items-center cursor-pointer">
                             ${icon}
                             <span class="text-xs text-center mt-1 font-medium ${isUnlocked ? 'text-gray-700' : 'text-gray-400'}">${badge.name}</span>
                         </div>
                     `;
                 }).join('');

                 badgeHTML += `</div></div>`;

                 profilePage.innerHTML = `
                 <div class="p-4 space-y-4">
                      <div class="bg-white p-4 rounded-xl shadow-sm">
                          <div class="flex items-center justify-between">
                               <img src="${studentData.avatar}" class="w-20 h-20 rounded-full border-4 border-white shadow-lg">
                               <div class="flex-grow text-center">
                                   <p class="font-bold text-lg">${studentData.followers.length}</p>
                                   <p class="text-gray-500 text-sm">Pengikut</p>
                               </div>
                               <div class="flex-grow text-center">
                                   <p class="font-bold text-lg">${studentData.following.length}</p>
                                   <p class="text-gray-500 text-sm">Mengikuti</p>
                               </div>
                          </div>
                           <h3 class="text-lg font-bold mt-3">${currentStudent.name}</h3>
                           <p class="text-gray-500 text-sm">NISN: ${currentStudent.nisn}</p>
                           <p class="text-xs text-gray-400 mt-1">${schoolData.name} | Kelas ${currentStudent.class} | Wali Kelas: ${schoolData.teacher}</p>
                      </div>
                     
                      ${badgeHTML}

                     <div class="bg-white rounded-xl shadow-sm">
                          <h3 class="px-4 pt-4 pb-2 text-sm font-bold text-gray-800">Unduh Laporan</h3>
                          <ul class="text-sm text-gray-700">
                               <li onclick="generateParentReflectionPDF(currentStudent)" class="flex items-center justify-between p-4 hover:bg-gray-50 cursor-pointer border-t">
                                   <div class="flex items-center gap-4">
                                       <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm-3 5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                       <span class="font-medium">Refleksi Orang Tua</span>
                                   </div>
                                   <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                               </li>
                           </ul>
                      </div>

                       <button onclick="handleLogout()" class="w-full bg-red-500 text-white py-2.5 rounded-lg hover:bg-red-600 transition">Logout</button>
                 </div>`;
            } else if (currentAdmin) {
                profilePage.innerHTML = `
                    <div class="p-4">
                        <div class="bg-white p-6 rounded-xl shadow-md text-center">
                            <img src="https://placehold.co/100x100/34D399/FFFFFF?text=G" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-white shadow-lg">
                            <h3 class="text-xl font-bold">${currentAdmin.username}</h3>
                            <p class="text-gray-500">Guru / Admin</p>
                            <button onclick="handleLogout()" class="mt-6 w-full bg-red-500 text-white py-2.5 rounded-lg hover:bg-red-600 transition">Logout</button>
                        </div>
                    </div>
                `;
            } else {
                 profilePage.innerHTML = `
                 <div class="p-4">
                      <div class="bg-white p-6 rounded-xl shadow-md text-center">
                           <img src="https://placehold.co/100x100/CBD5E1/FFFFFF?text=?" class="w-24 h-24 rounded-full mx-auto mb-4 border-4 border-white shadow-lg">
                           <h3 class="text-lg font-bold">Anda Belum Login</h3>
                           <p class="text-gray-500 mb-4">Silakan login untuk melanjutkan.</p>
                           <div class="space-y-3">
                               <button id="show-student-login-btn" class="w-full bg-blue-500 text-white py-2 rounded-lg">Login sebagai Siswa</button>
                               <button id="show-admin-login-btn" class="w-full bg-gray-700 text-white py-2 rounded-lg">Login sebagai Guru</button>
                           </div>
                      </div>
                 </div>`;
                el('show-student-login-btn').addEventListener('click', () => showLoginModal('student'));
                el('show-admin-login-btn').addEventListener('click', () => showLoginModal('admin'));
            }
        }

        function renderKontenPage() {
            const container = el('page-konten');
            if (!currentAdmin) {
                container.innerHTML = `<div class="text-center mt-8 p-4"><p class="text-gray-500">Hanya admin yang dapat mengakses halaman ini.</p><button onclick="switchPage('home')" class="mt-4 bg-blue-500 text-white py-2 px-4 rounded-lg">Kembali ke Beranda</button></div>`;
                return;
            }

            container.innerHTML = `
                <div class="space-y-6">
                    <!-- Video Management Section -->
                    <section class="bg-white p-4 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-gray-800">Kelola Video</h2>
                            <button onclick="showContentModal('video')" class="bg-blue-500 text-white text-sm font-semibold py-1.5 px-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Tambah
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                            ${videoCollection.map(video => `
                                <div class="rounded-lg overflow-hidden border border-gray-200">
                                    <img src="https://img.youtube.com/vi/${video.youtubeId}/0.jpg" alt="${video.title}" class="w-full h-24 object-cover">
                                    <div class="p-2">
                                        <h3 class="font-semibold text-sm truncate">${video.title}</h3>
                                        <div class="flex gap-2 mt-2">
                                            <button onclick="showContentModal('video', '${video.id}')" class="flex-1 bg-gray-200 text-gray-700 text-xs font-semibold py-1 rounded-md hover:bg-gray-300">Edit</button>
                                            <button onclick="handleDeleteContent('video', '${video.id}')" class="flex-1 bg-red-100 text-red-700 text-xs font-semibold py-1 rounded-md hover:bg-red-200">Hapus</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </section>

                    <!-- Book Management Section -->
                    <section class="bg-white p-4 rounded-xl shadow-sm">
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="text-lg font-bold text-gray-800">Kelola Buku</h2>
                             <button onclick="showContentModal('book')" class="bg-blue-500 text-white text-sm font-semibold py-1.5 px-3 rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-1">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" /></svg>
                                Tambah
                            </button>
                        </div>
                        <div class="grid grid-cols-2 gap-4">
                             ${bookCollection.map(book => `
                                <div class="rounded-lg overflow-hidden border border-gray-200">
                                    <img src="${book.cover}" alt="${book.title}" onerror="this.src='https://placehold.co/200x280/CCCCCC/FFFFFF?text=No+Image'" class="w-full h-32 object-cover">
                                    <div class="p-2">
                                        <h3 class="font-semibold text-sm truncate">${book.title}</h3>
                                        <div class="flex gap-2 mt-2">
                                            <button onclick="showContentModal('book', '${book.id}')" class="flex-1 bg-gray-200 text-gray-700 text-xs font-semibold py-1 rounded-md hover:bg-gray-300">Edit</button>
                                            <button onclick="handleDeleteContent('book', '${book.id}')" class="flex-1 bg-red-100 text-red-700 text-xs font-semibold py-1 rounded-md hover:bg-red-200">Hapus</button>
                                        </div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </section>

                    <!-- Student Report Section -->
                    <section class="bg-white rounded-xl shadow-sm">
                         <h3 class="px-4 pt-4 text-lg font-bold text-gray-800">Unduh Laporan Siswa</h3>
                         <div id="admin-report-controls" class="p-4"></div>
                    </section>
                </div>
            `;
            renderAdminReportDownloader();
        }
        
        function renderAdminReportDownloader() {
            const controlsContainer = el('admin-report-controls');
            if (!controlsContainer) return;

            const classes = [...new Set(Object.values(studentDatabase).map(s => s.class))].sort();

            controlsContainer.innerHTML = `
                <div class="space-y-4">
                    <div>
                        <label for="class-select" class="block text-sm font-medium text-gray-700 mb-1">Pilih Kelas</label>
                        <select id="class-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md">
                            <option value="">-- Semua Kelas --</option>
                            ${classes.map(c => `<option value="${c}">Kelas ${c}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label for="student-select" class="block text-sm font-medium text-gray-700 mb-1">Pilih Siswa</label>
                        <select id="student-select" class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" disabled>
                            <option value="">-- Pilih Kelas Dahulu --</option>
                        </select>
                    </div>
                    <div id="admin-download-buttons" class="hidden pt-4 mt-4 border-t">
                        <!-- Buttons will be injected here -->
                    </div>
                </div>
            `;

            const classSelect = el('class-select');
            const studentSelect = el('student-select');

            classSelect.addEventListener('change', () => {
                const selectedClass = classSelect.value;
                studentSelect.innerHTML = '<option value="">-- Pilih Siswa --</option>';
                el('admin-download-buttons').classList.add('hidden');

                if (selectedClass) {
                    const studentsInClass = Object.entries(studentDatabase).filter(([_, data]) => data.class === selectedClass);
                    studentSelect.innerHTML += studentsInClass.map(([nisn, data]) => `<option value="${nisn}">${data.name}</option>`).join('');
                    studentSelect.disabled = false;
                } else {
                    studentSelect.disabled = true;
                    studentSelect.innerHTML = '<option value="">-- Pilih Kelas Dahulu --</option>';
                }
            });

            studentSelect.addEventListener('change', () => {
                const selectedNisn = studentSelect.value;
                const downloadButtonsContainer = el('admin-download-buttons');

                if (selectedNisn) {
                    const studentData = { nisn: selectedNisn, ...studentDatabase[selectedNisn] };
                    downloadButtonsContainer.innerHTML = `
                        <ul class="text-sm text-gray-700 -mx-4">
                              <li onclick='generateParentReflectionPDF(${JSON.stringify(studentData)})' class="flex items-center justify-between p-4 hover:bg-gray-50 cursor-pointer border-t">
                                 <div class="flex items-center gap-4">
                                     <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm-3 5a2 2 0 11-4 0 2 2 0 014 0z" /></svg>
                                     <span class="font-medium">Refleksi Orang Tua</span>
                                 </div>
                                 <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5l7 7-7 7" /></svg>
                             </li>
                           </ul>
                    `;
                    downloadButtonsContainer.classList.remove('hidden');
                } else {
                    downloadButtonsContainer.classList.add('hidden');
                }
            });
        }


        function renderReportPage() {
            const container = el('page-report');
            if (!currentStudent) {
                container.innerHTML = `<div class="text-center mt-8 p-4"><p class="text-gray-500">Silakan login sebagai siswa untuk mengisi laporan.</p><button onclick="switchPage('profile')" class="mt-4 bg-blue-500 text-white py-2 px-4 rounded-lg">Ke Halaman Profil</button></div>`;
                return;
            }
            const habitHTML = habits.map(habit => {
                const habitId = habit.name.toLowerCase().replace(/\s/g, '-').replace(/&/g, 'dan');
                const timeInputHTML = habit.hasTimeInput ? `<input type="time" id="${habitId}-time" class="input-field text-sm w-28 mx-2 p-1.5 hidden">` : '';
                return `<div class="flex items-center justify-between p-3 bg-white rounded-lg border border-gray-200"><div class="flex items-center gap-3 flex-grow"><span class="text-gray-500">${habit.icon}</span><span class="text-gray-700 font-medium">${habit.name}</span></div>${timeInputHTML}<div class="relative inline-block w-10 mr-2 align-middle select-none"><input type="checkbox" name="${habitId}" id="${habitId}" class="toggle-checkbox absolute block w-6 h-6 rounded-full bg-white border-4 appearance-none cursor-pointer"/><label for="${habitId}" class="toggle-label block overflow-hidden h-6 rounded-full bg-gray-300 cursor-pointer"></label></div></div>`;
            }).join('');
            container.innerHTML = `<form id="habit-form"><h2 class="font-bold text-lg mb-3 text-center">Isi Laporan Hari Ini</h2><p class="text-center text-gray-500 mb-4">${new Date().toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'})}</p><div class="space-y-4">${habitHTML}</div><div class="mt-6"><button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2.5 px-6 rounded-lg">Posting Aktivitas</button></div></form>`;
            container.querySelector('#habit-form').addEventListener('submit', handleHabitFormSubmit);
            container.querySelectorAll('.toggle-checkbox').forEach(toggle => {
                toggle.addEventListener('change', (event) => {
                    const timeInput = container.querySelector(`#${event.target.id}-time`);
                    if (timeInput) timeInput.classList.toggle('hidden', !event.target.checked);
                });
            });
        }
        
        // --- LOGIC FUNCTIONS ---
        function showLoginModal(type) {
            const loginModal = el('login-modal');
            loginModal.innerHTML = `<div class="bg-white p-8 rounded-lg shadow-xl w-full max-w-sm"><h2 class="text-xl font-bold mb-4 text-center">${type === 'student' ? 'Login Siswa' : 'Login Guru'}</h2><form id="login-form-modal">${ type === 'student' ? `<input type="number" id="nisn-input" class="input-field text-center" placeholder="Masukkan NISN Anda" required>` : `<input type="text" id="admin-username" class="input-field mb-2" placeholder="Nama Pengguna" required><input type="password" id="admin-password" class="input-field" placeholder="Kata Sandi" required>` }<button type="submit" class="w-full bg-blue-500 text-white py-2 rounded-lg mt-4">Masuk</button><button type="button" class="close-modal-btn w-full bg-gray-200 mt-2 py-2 rounded-lg">Batal</button></form></div>`;
            loginModal.querySelector('.close-modal-btn').addEventListener('click', () => loginModal.classList.add('hidden'));
            loginModal.querySelector('#login-form-modal').addEventListener('submit', (e) => handleLoginSubmit(e, type));
            loginModal.classList.remove('hidden');
        }
        function handleLoginSubmit(e, type) {
            e.preventDefault();
            if (type === 'student') {
                const nisnInput = el('nisn-input');
                const student = studentDatabase[nisnInput.value];
                if (student) {
                    currentStudent = { nisn: nisnInput.value, ...student };
                    currentAdmin = null;
                } else { alert('NISN tidak ditemukan!'); return; }
            } else { // admin
                const adminUsernameInput = el('admin-username');
                const passwordInput = el('admin-password');
                if (adminUsernameInput.value === localAdmin.username && passwordInput.value === localAdmin.password) {
                    currentAdmin = { username: adminUsernameInput.value };
                    currentStudent = null;
                } else { alert('Username atau password guru salah!'); return; }
            }
            el('login-modal').classList.add('hidden');
            updateNavVisibility();
            switchPage('home'); // Go to home after login
        }
        function handleLogout() {
            currentStudent = null;
            currentAdmin = null;
            updateNavVisibility();
            switchPage('profile');
        }
        function handleHabitFormSubmit(e) {
            e.preventDefault();
            const completedHabits = habits.filter(h => el(h.name.toLowerCase().replace(/\s/g, '-').replace(/&/g, 'dan')).checked).map(h => h.name);
            if (completedHabits.length > 0) {
                const newActivity = { id: `act_${Date.now()}`, nisn: currentStudent.nisn, name: currentStudent.name, class: currentStudent.class, date: new Date().toLocaleDateString('id-ID', {day: '2-digit', month: 'long', year: 'numeric'}), completedHabits, avatar: currentStudent.avatar, likes: 0, likedBy: [] };
                activityFeed.push(newActivity);
                
                const studentData = studentDatabase[currentStudent.nisn];
                const currentDate = new Date().toISOString().slice(0, 10);
                
                completedHabits.forEach(habitName => {
                    if (!studentData.achievements[habitName]) {
                        studentData.achievements[habitName] = [];
                    }
                    if (!studentData.achievements[habitName].includes(currentDate)) {
                        studentData.achievements[habitName].push(currentDate);
                    }
                });

                if (completedHabits.length === habits.length) {
                    notifications.unshift({
                        type: 'badge',
                        actorName: currentStudent.name,
                        actorAvatar: currentStudent.avatar,
                        timestamp: new Date()
                    });
                    updateNotificationUI(true);
                }
                
                switchPage('home');
            } else {
                alert('Pilih minimal satu aktivitas.');
            }
        }
       
        function showBadgeDetailsModal(habitName) {
            const badge = badges.find(b => b.name === habitName);
            const studentData = studentDatabase[currentStudent.nisn];
            const habitAchievements = studentData.achievements[habitName] || [];
            const totalCompletions = habitAchievements.length;

            const months = [...new Set(habitAchievements.map(dateStr => {
                const date = new Date(dateStr);
                return date.toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
            }))];

            const modalContent = `
                <div class="bg-white p-6 rounded-2xl shadow-xl w-full max-w-xs text-center relative">
                    <button onclick="el('badge-details-modal').classList.add('hidden')" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600">
                         <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                    <div class="mx-auto w-20 h-20">${badge.unlockedIcon}</div>
                    <h3 class="text-lg font-bold mt-4">${badge.name}</h3>
                    <p class="text-sm text-gray-500">${badge.description}</p>
                    <div class="mt-4 bg-blue-50 p-3 rounded-lg">
                        <p class="text-sm font-medium text-blue-800">Total diselesaikan</p>
                        <p class="text-2xl font-bold text-blue-600">${totalCompletions} kali</p>
                    </div>
                    <div class="mt-4 text-left">
                        <p class="text-sm font-medium text-gray-700 mb-1">Diraih pada bulan:</p>
                        <ul class="text-sm text-gray-600 list-disc list-inside max-h-24 overflow-y-auto">
                            ${months.length > 0 ? months.map(m => `<li>${m}</li>`).join('') : '<li>Belum ada riwayat</li>'}
                        </ul>
                    </div>
                </div>
            `;
            const modalContainer = el('badge-details-modal');
            modalContainer.innerHTML = modalContent;
            modalContainer.classList.remove('hidden');
        }

        function handleLikePost(activityId) {
            if (!currentStudent) return;
            const activityIndex = activityFeed.findIndex(activity => activity.id === activityId);
            if (activityIndex === -1) return;
            const activity = activityFeed[activityIndex];
            const studentNisn = currentStudent.nisn;
            if (activity.likedBy.includes(studentNisn)) {
                activity.likes--;
                activity.likedBy = activity.likedBy.filter(nisn => nisn !== studentNisn);
            } else {
                activity.likes++;
                activity.likedBy.push(studentNisn);
                if(activity.nisn !== currentStudent.nisn) {
                    notifications.unshift({ 
                        type: 'like', 
                        actor: studentDatabase[currentStudent.nisn],
                        postOwner: studentDatabase[activity.nisn],
                        timestamp: new Date() 
                    });
                    updateNotificationUI(true);
                }
            }
            activityFeed[activityIndex] = activity;
            renderHomePage(); 
        }

        function handleFollowToggle(targetNisn) {
            if (!currentStudent) return;
            
            const currentUserNisn = currentStudent.nisn;
            const currentUserData = studentDatabase[currentUserNisn];
            const targetUserData = studentDatabase[targetNisn];

            if (!currentUserData || !targetUserData) return;

            const isFollowing = currentUserData.following.includes(targetNisn);

            if(isFollowing) {
                currentUserData.following = currentUserData.following.filter(nisn => nisn !== targetNisn);
                targetUserData.followers = targetUserData.followers.filter(nisn => nisn !== currentUserNisn);
            } else {
                currentUserData.following.push(targetNisn);
                targetUserData.followers.push(currentUserNisn);
                notifications.unshift({ 
                    type: 'follow', 
                    actor: studentDatabase[currentUserNisn], 
                    followedNisn: targetNisn, 
                    timestamp: new Date() 
                });
                updateNotificationUI(true);
            }

            studentDatabase[currentUserNisn] = currentUserData;
            studentDatabase[targetNisn] = targetUserData;
            currentStudent = { ...currentStudent, ...currentUserData };
            
            const activePageId = document.querySelector('.page.active').id.replace('page-', '');
            switchPage(activePageId);
        }
        
        // --- PDF GENERATION FUNCTIONS (UPDATED) ---
        function generateParentReflectionPDF(student) {
            if (!student) return;
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'pt', 'a4'); // Set format to A4
            
            doc.setFont('helvetica', 'bold');
            doc.setFontSize(16);
            doc.text("Lembar Refleksi Orang Tua", doc.internal.pageSize.getWidth() / 2, 60, { align: 'center' });
            
            doc.setFont('helvetica', 'normal');
            doc.setFontSize(12);
            doc.text(`Nama : ${student.name}`, 40, 90);
            doc.text(`Kelas : ${student.class}`, 40, 105);
            doc.text(`Bulan : _________________________`, 40, 120);

            let yPos = 150;

            habits.forEach(habit => {
                if (yPos > 680) { // Adjusted for more space
                    doc.addPage(); 
                    yPos = 40; 
                }
                doc.setFont('helvetica', 'bold');
                doc.setFontSize(11);
                doc.text(habit.name, 40, yPos);
                
                doc.setFont('helvetica', 'normal');
                doc.setFontSize(10);
                doc.text("Kesimpulan/Refleksi:", 42, yPos + 20);
                doc.rect(40, yPos + 25, doc.internal.pageSize.getWidth() - 80, 50); // Increased height
                doc.text("Tindak Lanjut:", 42, yPos + 90);
                doc.rect(40, yPos + 95, doc.internal.pageSize.getWidth() - 80, 50); // Increased height
                yPos += 160;
            });

            // Add signature section
            if (yPos > 680) { // Check for page break before adding signatures
                doc.addPage();
                yPos = 40;
            } else {
                yPos += 20;
            }
            
            const today = new Date();
            const formattedDate = today.toLocaleDateString('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            const marginRight = 40;
            const pageWidth = doc.internal.pageSize.getWidth();

            doc.setFontSize(10);
            doc.text(`Indramayu, ${formattedDate}`, pageWidth - marginRight, yPos, { align: 'right' });
            
            yPos += 15;
            doc.text("Guru Kelas/Wali Kelas,", pageWidth - marginRight, yPos, { align: 'right' });

            // Parent signature on the left, aligned with Teacher's signature
            const parentX = 40;
            doc.text("Orang Tua/Wali Murid,", parentX, yPos);
            
            yPos += 50; // Space for signature
            doc.text(`(${schoolData.teacher})`, pageWidth - marginRight, yPos, { align: 'right' });
            doc.text("(___________________)", parentX, yPos);
            
            doc.save(`refleksi-orang-tua-${student.nisn}.pdf`);
        }
        
        // --- CONTENT MANAGEMENT FUNCTIONS ---
        function showContentModal(type, id = null) {
            const modal = el('content-modal');
            const isEdit = id !== null;
            const title = `${isEdit ? 'Edit' : 'Tambah'} ${type === 'video' ? 'Video' : 'Buku'}`;
            let item = {};
            let formFields = '';

            if (type === 'video') {
                if (isEdit) item = videoCollection.find(v => v.id === id);
                formFields = `
                    <div class="space-y-2">
                        <label for="content-title" class="block text-sm font-medium text-gray-700">Judul Video</label>
                        <input type="text" id="content-title" value="${item.title || ''}" class="input-field" required>
                    </div>
                    <div class="space-y-2">
                        <label for="content-youtube-id" class="block text-sm font-medium text-gray-700">YouTube Video ID</label>
                        <input type="text" id="content-youtube-id" value="${item.youtubeId || ''}" class="input-field" required>
                    </div>
                `;
            } else { // book
                if (isEdit) item = bookCollection.find(b => b.id === id);
                formFields = `
                    <div class="space-y-2">
                        <label for="content-title" class="block text-sm font-medium text-gray-700">Judul Buku</label>
                        <input type="text" id="content-title" value="${item.title || ''}" class="input-field" required>
                    </div>
                    <div class="space-y-2">
                        <label for="content-url" class="block text-sm font-medium text-gray-700">URL Buku</label>
                        <input type="url" id="content-url" value="${item.url || ''}" class="input-field" required>
                    </div>
                     <div class="space-y-2">
                        <label for="content-cover" class="block text-sm font-medium text-gray-700">URL Cover Buku</label>
                        <input type="url" id="content-cover" value="${item.cover || ''}" class="input-field" required>
                    </div>
                `;
            }

            modal.innerHTML = `
                <div class="bg-white p-6 rounded-lg shadow-xl w-full max-w-sm">
                    <h2 class="text-xl font-bold mb-4">${title}</h2>
                    <form id="content-form" class="space-y-4">
                        ${formFields}
                        <div class="flex justify-end gap-3 pt-4">
                             <button type="button" onclick="el('content-modal').classList.add('hidden')" class="bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300">Batal</button>
                             <button type="submit" class="bg-blue-500 text-white py-2 px-4 rounded-lg hover:bg-blue-600">Simpan</button>
                        </div>
                    </form>
                </div>
            `;
            modal.classList.remove('hidden');
            el('content-form').addEventListener('submit', (e) => {
                e.preventDefault();
                handleContentSubmit(type, id);
            });
        }

        function handleContentSubmit(type, id) {
            const title = el('content-title').value;
            if (!title) {
                alert('Judul tidak boleh kosong.');
                return;
            }

            if (type === 'video') {
                const youtubeId = el('content-youtube-id').value;
                if (!youtubeId) {
                    alert('YouTube ID tidak boleh kosong.');
                    return;
                }
                if (id) { // Edit
                    const index = videoCollection.findIndex(v => v.id === id);
                    if (index > -1) {
                        videoCollection[index].title = title;
                        videoCollection[index].youtubeId = youtubeId;
                    }
                } else { // Add
                    videoCollection.push({ id: `vid_${Date.now()}`, title, youtubeId });
                }
            } else { // book
                const url = el('content-url').value;
                const cover = el('content-cover').value;
                if (!url || !cover) {
                    alert('URL Buku dan Cover tidak boleh kosong.');
                    return;
                }
                if (id) { // Edit
                    const index = bookCollection.findIndex(b => b.id === id);
                    if (index > -1) {
                        bookCollection[index].title = title;
                        bookCollection[index].url = url;
                        bookCollection[index].cover = cover;
                    }
                } else { // Add
                    bookCollection.push({ id: `book_${Date.now()}`, title, url, cover });
                }
            }

            el('content-modal').classList.add('hidden');
            renderKontenPage();
            // Also refresh video/book page if it's active
            if (el('page-video').classList.contains('active')) renderVideoPage();
            if (el('page-book').classList.contains('active')) renderBookPage();
        }

        function handleDeleteContent(type, id) {
            // A simple confirmation before deleting. In a real app, a custom modal is better than a native confirm.
            // For this environment, we simulate a simple yes/no.
            const userConfirmed = (prompt(`Apakah Anda yakin ingin menghapus item ini? Ketik 'YA' untuk konfirmasi.`) || '').toUpperCase() === 'YA';

            if (userConfirmed) {
                if (type === 'video') {
                    videoCollection = videoCollection.filter(v => v.id !== id);
                } else { // book
                    bookCollection = bookCollection.filter(b => b.id !== id);
                }
                renderKontenPage();
                 if (el('page-video').classList.contains('active')) renderVideoPage();
                 if (el('page-book').classList.contains('active')) renderBookPage();
            }
        }

        function timeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            if (seconds < 5) return "Baru saja";
            let interval = seconds / 31536000; if (interval > 1) return Math.floor(interval) + " tahun lalu";
            interval = seconds / 2592000; if (interval > 1) return Math.floor(interval) + " bulan lalu";
            interval = seconds / 86400; if (interval > 1) return Math.floor(interval) + " hari lalu";
            interval = seconds / 3600; if (interval > 1) return Math.floor(interval) + " jam lalu";
            interval = seconds / 60; if (interval > 1) return Math.floor(interval) + " menit lalu";
            return Math.floor(seconds) + " detik lalu";
        }
        
        // --- NEW NOTIFICATION SYSTEM ---
        function initializeNotifications() {
            notifications = [
                { type: 'badge', actorName: 'Budi', actorAvatar: studentDatabase['12345'].avatar, timestamp: new Date(new Date().setDate(new Date().getDate() - 2)) },
                { type: 'like', actor: studentDatabase['11223'], postOwner: studentDatabase['12345'], timestamp: new Date(new Date().setDate(new Date().getDate() - 1)) },
                { type: 'follow', actor: studentDatabase['54321'], timestamp: new Date(new Date().setDate(new Date().getDate() - 8)) }
            ];
            updateNotificationUI(true);
        }

        function updateNotificationUI(hasNew) {
            if (hasNew) {
                el('notification-dot').classList.remove('hidden');
            }
        }
        
        function showNotificationPage() {
            const container = el('notification-page-container');
            if (!currentStudent) return;
            
            container.innerHTML = `
                <div class="w-full h-full bg-white flex flex-col">
                    <div class="p-4 border-b flex items-center">
                        <button onclick="closeNotificationPage()" class="mr-4 text-gray-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15 19l-7-7 7-7" /></svg>
                        </button>
                        <h2 class="text-lg font-bold text-gray-800 flex-grow">Notifikasi</h2>
                    </div>
                    <div id="notification-list" class="flex-grow overflow-y-auto p-2"></div>
                </div>
            `;
            renderNotifications();
            container.classList.remove('hidden', 'translate-x-full');
            el('notification-dot').classList.add('hidden');
        }

        function closeNotificationPage() {
            const container = el('notification-page-container');
            container.classList.add('translate-x-full');
            setTimeout(() => container.classList.add('hidden'), 300);
        }
        
        function renderNotifications() {
            const listContainer = el('notification-list');
            if (!currentStudent || !listContainer) return;
            
            const relevantNotifications = notifications.filter(notif => {
                if (notif.type === 'badge' && notif.actorName === currentStudent.name) return true;
                if (notif.type === 'like' && notif.postOwner.nisn === currentStudent.nisn) return true;
                 if (notif.type === 'follow' && notif.actor.nisn !== currentStudent.nisn && !currentStudent.following.includes(notif.actor.nisn) ) return true; // Show follow notifs from non-followers
                return false;
            }).sort((a,b) => b.timestamp - a.timestamp);
            
            if (relevantNotifications.length === 0) {
                 listContainer.innerHTML = `<p class="text-center text-gray-500 p-8">Tidak ada aktivitas terbaru.</p>`;
                 return;
            }

            const groupNotificationsByTime = (notifications) => {
                const groups = { "Minggu Ini": [], "Bulan Ini": [], "Sebelumnya": [] };
                const now = new Date();
                const oneWeekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                const oneMonthAgo = new Date(now.getFullYear(), now.getMonth() - 1, now.getDate());

                notifications.forEach(n => {
                    const notifDate = n.timestamp;
                    if (notifDate > oneWeekAgo) groups["Minggu Ini"].push(n);
                    else if (notifDate > oneMonthAgo) groups["Bulan Ini"].push(n);
                    else groups["Sebelumnya"].push(n);
                });
                return groups;
            };

            const grouped = groupNotificationsByTime(relevantNotifications);
            let contentHTML = '';

            for (const groupName in grouped) {
                if (grouped[groupName].length > 0) {
                    contentHTML += `<h3 class="font-bold text-md p-2 text-gray-800">${groupName}</h3>`;
                    contentHTML += grouped[groupName].map(notif => {
                        let message = '';
                        let avatarUrl = notif.actor ? notif.actor.avatar : notif.actorAvatar;
                        if (notif.type === 'like') {
                            message = `<b>${notif.actor.name}</b> menyukai postingan Anda.`;
                        } else if (notif.type === 'follow') {
                            message = `<b>${notif.actor.name}</b> mulai mengikuti Anda.`;
                        } else if (notif.type === 'badge') {
                            message = `<b>Selamat!</b> Kamu baru saja mendapatkan semua lencana pencapaian.`;
                        }
                        return `
                        <div class="flex items-center gap-3 p-3 hover:bg-gray-50 rounded-lg">
                           <img src="${avatarUrl}" class="w-10 h-10 rounded-full">
                           <p class="text-sm text-gray-800 flex-grow">${message}</p>
                           <span class="text-xs text-gray-400">${timeAgo(notif.timestamp)}</span>
                        </div>`;
                    }).join('');
                }
            }
            listContainer.innerHTML = contentHTML;
        }

    </script>
</body>
</html>
